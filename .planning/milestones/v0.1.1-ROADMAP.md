# Milestone v0.1.1: Bug Fixes & Architecture

**Status:** SHIPPED 2026-02-20
**Phases:** 11-13
**Total Plans:** 4

## Overview

Fix behavioral gaps and improve architecture in the core workout loop. Added incrementally as issues were discovered after v0.1 MVP ship.

## Phases

### Phase 11: Silent Save of Weight/Reps to Template

**Goal**: When a user modifies weight/reps during an active workout and finishes the workout, silently save completed set values back to the template — matching existing rest timer silent save behavior.
**Depends on**: Phase 5 (Active Workout)
**Plans**: 1 plan

Plans:
- [x] 11-01-PLAN.md — Add updateTemplateExerciseSetValues service, getWeightRepsChanges hook, wire into workout finish flow

**Details:**
- Added `updateTemplateExerciseSetValues()` standalone export in `templates.ts`
- Added `getWeightRepsChanges()` to `useWorkoutState` hook
- Wired `saveWeightRepsChanges()` into `workout.tsx` alongside `saveRestTimeChanges()`
- Template cache refresh after successful silent saves
- No auth check (RLS handles authorization, best-effort pattern)

**Requirements:** FIX-01

### Phase 12: Database Creation Limits via Triggers

**Goal**: Implement BEFORE INSERT trigger functions on Supabase to enforce max row counts as a database-level safety net.
**Depends on**: Phase 1 (Foundation)
**Plans**: 1 plan

Plans:
- [x] 12-01-PLAN.md — SQL migration with 7 trigger functions (advisory locks, P0001 ERRCODE) + error documentation

**Details:**
- 7 BEFORE INSERT trigger functions with advisory locks (pg_advisory_xact_lock)
- Limits: templates (20), custom exercises (50), charts (25), exercises per template/workout (15), sets per exercise (10)
- System exercises (is_system = true) bypass exercise limit trigger
- Structured error message format: `LIMIT_EXCEEDED:{entity}:{limit}`
- Standard P0001 ERRCODE (custom SQLSTATE codes rejected by PostgreSQL/Supabase)
- Idempotent migration deployed and verified in Supabase SQL Editor

### Phase 13: Test Harness for Unit Testing

**Goal**: Set up a React Native/Expo-compatible unit test harness using Jest and @testing-library/react-native, enabling reliable unit and component testing across the codebase.
**Depends on**: Phase 12
**Plans**: 2 plans

Plans:
- [x] 13-01-PLAN.md — Install test dependencies, create Jest config and global setup
- [x] 13-02-PLAN.md — Proof-of-concept tests (utilities + component render)

**Details:**
- Installed jest-expo ~54.0.17, jest ~29.7.0, @testing-library/react-native ^13.3.3, react-test-renderer 19.1.0
- jest.config.js with jest-expo preset, transformIgnorePatterns, setupFilesAfterEnv
- jest-setup.ts with 7 mock sections (Reanimated, Gesture Handler, AsyncStorage, Supabase env vars, expo-sqlite, Supabase client)
- Custom render helper wrapping components in ThemeProvider
- 21 passing proof-of-concept tests across 3 suites (formatters, timeUtils, SubmitButton)

---

## Milestone Summary

**Key Decisions:**

- No auth check in updateTemplateExerciseSetValues (RLS handles authorization, best-effort pattern)
- Cache refresh via getTemplates() + setCachedTemplates() after successful silent saves
- Use standard P0001 ERRCODE instead of custom LIMxx codes (custom SQLSTATE codes rejected by PostgreSQL/Supabase)
- Client-side identification via error.message prefix parsing instead of error.code matching
- Advisory locks (pg_advisory_xact_lock) for concurrency safety at minimal complexity
- jest.config.js over jest.config.ts (avoids ts-node dependency)
- Let jest-expo auto-resolve @/* path alias from tsconfig.json
- testPathIgnorePatterns for __tests__/helpers/ (prevents false test suite failures)

**Issues Resolved:**

- Custom SQLSTATE codes (LIM01-LIM07) rejected by PostgreSQL/Supabase; switched to P0001 with structured messages
- NativeAnimatedHelper mock path gone in RN 0.81+; removed (Reanimated setUpTests() handles it)
- Jest discovering helper files as test suites; excluded via testPathIgnorePatterns

**Issues Deferred:**

- Service-layer limit checks with user-facing error messages (deferred to v0.2)
- Auth email trampoline migration to Edge Function (deferred to v0.2)

**Technical Debt Incurred:**

- DB triggers enforce limits but no service-layer or UI feedback yet — users hit raw database errors on limit breach

---

_For current project status, see .planning/ROADMAP.md (created for next milestone)_
