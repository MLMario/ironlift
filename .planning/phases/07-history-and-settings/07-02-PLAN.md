---
phase: 07-history-and-settings
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/lib/formatters.ts
  - src/components/SummaryStatsBar.tsx
  - src/components/WorkoutHistoryCard.tsx
  - app/settings/history.tsx
autonomous: true

must_haves:
  truths:
    - "Workout History screen shows a sticky summary stats bar with total workouts, total sets, and total volume"
    - "History shows a paginated timeline with decorative vertical line and dots"
    - "Each workout entry shows template name, exercise count, completed sets, and total volume"
    - "Date markers show short format like 'Feb 5'"
    - "Scrolling near the bottom auto-loads the next page of 7 items"
    - "Empty state shows 'No workout history yet'"
    - "Tapping a workout card navigates to the workout detail screen"
  artifacts:
    - path: "src/lib/formatters.ts"
      provides: "formatVolume, formatWorkoutDate, formatDetailDate utilities"
      exports: ["formatVolume", "formatWorkoutDate", "formatDetailDate"]
    - path: "src/components/SummaryStatsBar.tsx"
      provides: "Three-box sticky stats bar"
      min_lines: 40
    - path: "src/components/WorkoutHistoryCard.tsx"
      provides: "Workout card with template name and metric badges"
      min_lines: 40
    - path: "app/settings/history.tsx"
      provides: "Workout History screen with FlatList timeline"
      min_lines: 100
  key_links:
    - from: "app/settings/history.tsx"
      to: "src/services/logging.ts"
      via: "logging.getWorkoutLogsPaginated and logging.getWorkoutSummaryStats"
      pattern: "logging\\.(getWorkoutLogsPaginated|getWorkoutSummaryStats)"
    - from: "app/settings/history.tsx"
      to: "app/settings/[workoutId].tsx"
      via: "router.push on card tap"
      pattern: "router\\.push.*settings/"
    - from: "src/components/SummaryStatsBar.tsx"
      to: "src/lib/formatters.ts"
      via: "formatVolume for volume display"
      pattern: "formatVolume"
---

<objective>
Build the Workout History screen with paginated timeline, summary stats bar, and workout cards -- replacing the placeholder history screen.

Purpose: Users need to review their past workouts with summary metrics and a visual timeline. This is a core feature for tracking workout consistency.
Output: Fully functional history screen with infinite scroll, sticky stats, timeline decoration, and navigation to workout detail.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-history-and-settings/07-CONTEXT.md
@.planning/phases/07-history-and-settings/07-RESEARCH.md
@src/services/logging.ts
@src/types/services.ts
@src/types/database.ts
@app/settings/history.tsx
@app/settings/_layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create formatters utility and SummaryStatsBar + WorkoutHistoryCard components</name>
  <files>src/lib/formatters.ts, src/components/SummaryStatsBar.tsx, src/components/WorkoutHistoryCard.tsx</files>
  <action>
**1. Create `src/lib/formatters.ts`** with three exported utility functions:

```typescript
export function formatVolume(n: number): string {
  if (n >= 1000) {
    const k = n / 1000;
    return k % 1 === 0 ? k + 'k' : k.toFixed(1) + 'k';
  }
  return n.toLocaleString();
}

export function formatWorkoutDate(isoString: string): string {
  const date = new Date(isoString);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

export function formatDetailDate(isoString: string): string {
  const date = new Date(isoString);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
```

**2. Create `src/components/SummaryStatsBar.tsx`:**

Props:
```typescript
interface SummaryStatsBarProps {
  totalWorkouts: number;
  totalSets: number;
  totalVolume: number;
  isLoading?: boolean;
}
```

Renders a horizontal row of three equal-width stat boxes inside a container with bgSurface background. Each box:
- Value text: accent color, fontFamily 'Menlo' (monospace on iOS), fontSize lg, fontWeight bold
- Label text: textMuted color, uppercase, fontSize xs, fontWeight medium, letterSpacing 1
- Stats: "Workouts" / totalWorkouts, "Sets" / totalSets, "Volume" / formatVolume(totalVolume)
- Box: flex 1, alignItems center, paddingVertical spacing.sm
- Container: flexDirection row, backgroundColor bgSurface, paddingVertical spacing.sm, paddingHorizontal spacing.xs, borderBottomWidth 1, borderBottomColor border

Show "0" values while loading (per research -- always render the stats bar, never conditionally omit).

**3. Create `src/components/WorkoutHistoryCard.tsx`:**

Props:
```typescript
interface WorkoutHistoryCardProps {
  workout: WorkoutHistoryItem;
  onPress: () => void;
}
```

Import `WorkoutHistoryItem` from `@/types/services`. Import `formatVolume` from `@/lib/formatters`.

Renders a Pressable card:
- Container: backgroundColor bgSurface, borderRadius md, padding md, borderWidth 1, borderColor border
- Pressed state: backgroundColor bgElevated
- Title: template_name or "Untitled Workout" (if template_name is null), fontSize base, fontWeight semibold, color textPrimary, marginBottom spacing.xs
- Badge row (flexDirection row, gap spacing.sm, flexWrap wrap):
  - Exercise count badge: "{exercise_count} exercises" -- bgElevated background, borderRadius sm, paddingHorizontal spacing.sm, paddingVertical 2
  - Completed sets badge: "{completed_sets} sets"
  - Total volume badge: formatVolume(total_volume) + " vol"
  - Badge text: fontSize xs, color textSecondary
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Verify all three files compile without type errors.
  </verify>
  <done>formatters.ts exports formatVolume/formatWorkoutDate/formatDetailDate. SummaryStatsBar renders three stat boxes. WorkoutHistoryCard renders a tappable card with workout info and metric badges.</done>
</task>

<task type="auto">
  <name>Task 2: Build Workout History screen with FlatList timeline and infinite scroll</name>
  <files>app/settings/history.tsx</files>
  <action>
Replace the placeholder `app/settings/history.tsx` with the full Workout History screen.

**Imports:**
- React: useState, useEffect, useCallback
- RN: View, Text, FlatList, ActivityIndicator, Pressable, StyleSheet
- SafeAreaView from react-native-safe-area-context
- useRouter from expo-router
- useTheme, type Theme from @/theme
- Ionicons from @expo/vector-icons
- logging from @/services/logging
- SummaryStatsBar from @/components/SummaryStatsBar
- WorkoutHistoryCard from @/components/WorkoutHistoryCard
- formatWorkoutDate from @/lib/formatters
- WorkoutHistoryItem from @/types/services
- WorkoutSummaryStats from @/types/services

**State:**
```typescript
const [workouts, setWorkouts] = useState<WorkoutHistoryItem[]>([]);
const [stats, setStats] = useState<WorkoutSummaryStats>({ totalWorkouts: 0, totalSets: 0, totalVolume: 0 });
const [isLoading, setIsLoading] = useState(true);
const [isLoadingMore, setIsLoadingMore] = useState(false);
const [hasMore, setHasMore] = useState(true);
const [statsLoaded, setStatsLoaded] = useState(false);
```

**PAGE_SIZE = 7** (matching web app).

**Load functions:**

`loadInitial()` -- called on mount via useEffect:
1. Set isLoading = true
2. Fetch in parallel: `logging.getWorkoutLogsPaginated(0, PAGE_SIZE)` and `logging.getWorkoutSummaryStats()`
3. Set workouts from paginated result.data.data
4. Set hasMore from paginated result.data.hasMore
5. Set stats from summary result.data
6. Set isLoading = false, statsLoaded = true

`loadMore()` -- called by FlatList onEndReached:
1. Guard: if `isLoadingMore || !hasMore` return
2. Set isLoadingMore = true
3. Fetch `logging.getWorkoutLogsPaginated(workouts.length, PAGE_SIZE)`
4. Append new items to workouts: `setWorkouts(prev => [...prev, ...result.data.data])`
5. Set hasMore from result.data.hasMore
6. Set isLoadingMore = false

**Header (custom, not part of FlatList):**
A top bar with a back button and title:
- Container: flexDirection row, alignItems center, paddingHorizontal spacing.md, paddingVertical spacing.sm, borderBottomWidth 1, borderBottomColor border
- Back button: Pressable with Ionicons "chevron-back", size 24, color textPrimary, minWidth/minHeight 44
- Title: "Workout History", fontSize xl, fontWeight semibold, color textPrimary, flex 1, textAlign center
- Spacer View (width 44 to balance the back button)

**FlatList configuration:**
```tsx
<FlatList
  data={workouts}
  renderItem={renderItem}
  keyExtractor={(item) => item.id}
  onEndReached={loadMore}
  onEndReachedThreshold={0.3}
  ListHeaderComponent={
    <SummaryStatsBar
      totalWorkouts={stats.totalWorkouts}
      totalSets={stats.totalSets}
      totalVolume={stats.totalVolume}
      isLoading={!statsLoaded}
    />
  }
  stickyHeaderIndices={[0]}
  ListFooterComponent={isLoadingMore ? <ActivityIndicator size="small" color={theme.colors.accent} style={{ paddingVertical: 16 }} /> : null}
  ListEmptyComponent={!isLoading ? <View style={styles.emptyContainer}><Text style={styles.emptyText}>No workout history yet</Text></View> : null}
  contentContainerStyle={workouts.length === 0 && !isLoading ? styles.emptyList : styles.listContent}
  showsVerticalScrollIndicator={false}
/>
```

**renderItem function:**
Each item renders a timeline entry with decorative dot and the workout card.

```tsx
const renderItem = useCallback(({ item, index }: { item: WorkoutHistoryItem; index: number }) => (
  <View style={styles.timelineItem}>
    {/* Dot */}
    <View style={styles.timelineDot} />
    {/* Content */}
    <View style={styles.timelineContent}>
      <Text style={styles.dateText}>{formatWorkoutDate(item.started_at)}</Text>
      <WorkoutHistoryCard
        workout={item}
        onPress={() => router.push(`/settings/${item.id}`)}
      />
    </View>
  </View>
), [router, styles]);
```

**Timeline container wrapping the FlatList:**
The vertical timeline line is an absolute-positioned View rendered inside the FlatList's container. Since FlatList doesn't support arbitrary children, implement the timeline line as part of the overall container. Use `CellRendererComponent` or wrap the FlatList in a View with the line:

Actually, the cleaner approach: Wrap the FlatList in a View container. The timeline line is positioned absolute in a wrapper INSIDE the FlatList content. Since we need the line to span the full height of all items, the simplest approach is to render the vertical line per-item (extends from dot down to next item) rather than a single continuous line.

Per-item approach:
- Each timeline item has a dot AND a vertical line segment extending downward
- Line segment: absolute positioned, left: 6 (center of 10px dot at left -28 + 28 = 0... let me recalculate)

Given the timeline container uses paddingLeft 28 and dots are positioned at left -22 (relative to content), the absolute line positioning:

Actually, simplify. The FlatList items container has position relative. Each item:
- Has `paddingLeft: 28` to leave room for the decorative elements
- Dot: absolute, `left: 2` (to center a 10px dot: left=2, width=10, center at 7), `top: 18` (align with card)
- Line segment below dot: absolute, `left: 6` (center of dot), `top: 28` (below dot), `bottom: 0`, `width: 2`
- Last item: no line segment (use index check or a separate flag)

Styles for timeline (use theme tokens):
```typescript
timelineItem: {
  paddingLeft: 28,
  paddingBottom: 16, // theme.spacing.md for gap between items
  position: 'relative' as const,
},
timelineDot: {
  position: 'absolute' as const,
  left: 2,
  top: 18,
  width: 10,
  height: 10,
  borderRadius: 5,
  backgroundColor: theme.colors.accent,
},
timelineLine: {
  position: 'absolute' as const,
  left: 6,
  top: 28,
  bottom: 0,
  width: 2,
  backgroundColor: theme.colors.border,
  borderRadius: 1,
},
```

In renderItem, conditionally render the timelineLine only when `index < workouts.length - 1` (not the last item). Pass `isLast` or check index directly.

**Loading state:** Show centered ActivityIndicator when `isLoading` is true.

**Navigation header back button:** `router.back()` on press.

**Full screen layout:**
```tsx
<SafeAreaView style={styles.container}>
  {/* Header bar */}
  <View style={styles.header}>...</View>
  {/* Loading spinner or FlatList */}
  {isLoading ? (
    <View style={styles.loadingContainer}>
      <ActivityIndicator size="large" color={theme.colors.accent} />
    </View>
  ) : (
    <FlatList ... />
  )}
</SafeAreaView>
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Navigate to Workout History from settings sheet on device
3. Summary stats bar is sticky at top with correct values
4. Timeline with dots and lines renders correctly
5. Scrolling near bottom loads more items
6. Empty state shows when no workouts exist
7. Tapping a card navigates (will show placeholder detail screen for now)
  </verify>
  <done>History screen shows paginated timeline with sticky stats, decorative timeline dots/lines, workout cards with badges, infinite scroll pagination, empty state, and navigation to workout detail route.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. formatVolume correctly formats: 45200 -> "45.2k", 1000 -> "1k", 750 -> "750"
3. formatWorkoutDate formats ISO date to "Feb 5" format
4. SummaryStatsBar shows three stat boxes with monospace values
5. History screen loads and shows paginated workout data
6. Stats bar is sticky (does not scroll away)
7. Timeline has vertical line segments and accent dots
8. Scrolling near bottom auto-loads next page of 7 items
9. Empty state message renders when no workouts
10. Tapping a workout card navigates to /settings/{workoutId}
</verification>

<success_criteria>
- Workout History screen fully replaces placeholder
- Summary stats bar is sticky with correct totals
- Timeline visual treatment with line and dots matches web app
- Infinite scroll pagination works with 7-item pages
- Empty state handles no workouts gracefully
- Cards navigate to detail route
</success_criteria>

<output>
After completion, create `.planning/phases/07-history-and-settings/07-02-SUMMARY.md`
</output>
