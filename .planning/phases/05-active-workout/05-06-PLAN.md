---
phase: 05-active-workout
plan: 06
type: execute
wave: 3
depends_on: ["05-05"]
files_modified:
  - app/index.tsx
autonomous: false

must_haves:
  truths:
    - "Tapping Start on a template card navigates to the active workout screen"
    - "On app relaunch with a saved workout, user sees resume modal on dashboard"
    - "Resuming navigates to workout screen with all previously entered data intact"
    - "Discarding removes saved data and stays on dashboard"
  artifacts:
    - path: "app/index.tsx"
      provides: "Dashboard with Start button wiring and crash recovery"
  key_links:
    - from: "app/index.tsx"
      to: "app/workout.tsx"
      via: "router.push with templateId param"
      pattern: "router\\.push.*workout.*templateId"
    - from: "app/index.tsx"
      to: "src/hooks/useWorkoutBackup.ts"
      via: "restore() check on mount for crash recovery"
      pattern: "useWorkoutBackup|restore"
    - from: "app/index.tsx"
      to: "src/components/ResumeWorkoutModal.tsx"
      via: "Resume modal when saved workout found"
      pattern: "ResumeWorkoutModal"
---

<objective>
Wire the dashboard's Start button to navigate to the workout screen, add crash recovery check on dashboard mount (resume modal), and verify the complete end-to-end workout flow on a physical device.

Purpose: This is the final integration step connecting the dashboard to the workout screen and adding crash recovery. After this plan, the full workout flow is functional.
Output: Updated index.tsx with Start button navigation and crash recovery, followed by human verification
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-active-workout/05-CONTEXT.md
@.planning/phases/05-active-workout/05-RESEARCH.md
@app/index.tsx
@app/workout.tsx
@src/hooks/useWorkoutBackup.ts
@src/components/ResumeWorkoutModal.tsx
@src/hooks/useAuth.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Start button and crash recovery on dashboard</name>
  <files>app/index.tsx</files>
  <action>
    Update the dashboard screen (app/index.tsx) with two integrations:

    **1. Start button navigation:**
    Replace the no-op `handleStart` function:
    ```typescript
    function handleStart(template: TemplateWithExercises) {
      router.push(`/workout?templateId=${template.id}`);
    }
    ```
    This passes the template ID as a query parameter. The workout screen (Plan 05) reads this param to load the template.

    **2. Crash recovery check:**
    Add crash recovery on dashboard mount:
    - Import useAuth to get userId: `const { user } = useAuth()`
    - Import useWorkoutBackup: `const backup = useWorkoutBackup(user?.id)`
    - Import ResumeWorkoutModal from components
    - Add state: `const [resumeData, setResumeData] = useState<WorkoutBackupData | null>(null)`
    - Add state: `const [showResumeModal, setShowResumeModal] = useState(false)`

    On mount (useEffect), check for saved workout:
    ```typescript
    useEffect(() => {
      const checkSavedWorkout = async () => {
        if (!user?.id) return;
        const data = await backup.restore();
        if (data) {
          setResumeData(data);
          setShowResumeModal(true);
        }
      };
      checkSavedWorkout();
    }, [user?.id]);
    ```

    Resume handler:
    ```typescript
    function handleResume() {
      setShowResumeModal(false);
      router.push('/workout?restore=true');
    }
    ```

    Discard handler (no confirmation per locked decision):
    ```typescript
    async function handleDiscard() {
      setShowResumeModal(false);
      await backup.clear();
      setResumeData(null);
    }
    ```

    Render the ResumeWorkoutModal:
    ```jsx
    <ResumeWorkoutModal
      visible={showResumeModal}
      templateName={resumeData?.activeWorkout?.template_name || 'Unknown'}
      startedAt={resumeData?.activeWorkout?.started_at || ''}
      onResume={handleResume}
      onDiscard={handleDiscard}
    />
    ```

    Add this modal inside the SafeAreaView, after TemplateGrid.

    **Imports to add:**
    - useAuth from '@/hooks/useAuth'
    - useWorkoutBackup, type WorkoutBackupData from '@/hooks/useWorkoutBackup'
    - ResumeWorkoutModal from '@/components/ResumeWorkoutModal'
    - useState, useEffect (already imported via useCallback)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - handleStart navigates to /workout?templateId=...
    - Dashboard checks for saved workout on mount
    - ResumeWorkoutModal renders when saved workout found
    - Resume navigates to /workout?restore=true
    - Discard clears backup and closes modal
  </verify>
  <done>
    - Start button navigates to workout screen with template ID
    - Crash recovery check runs on dashboard mount
    - Resume modal shows template name and time since start
    - Discard immediately clears saved data (no confirmation)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete active workout flow:
    1. Start a workout from a template card on the dashboard
    2. See all exercises with weight/reps inputs and done checkboxes
    3. Toggle set completion (triggers rest timer with countdown)
    4. Add/remove sets (swipe-to-delete on sets)
    5. Add/remove exercises mid-workout
    6. Rest timer with +/-10s adjustment, haptic on completion
    7. Finish workout (saves to database, detects template changes)
    8. Cancel workout (discards all progress)
    9. Crash recovery (kill app mid-workout, relaunch, see resume modal)
    10. Offline support (turn off WiFi, finish workout, it queues for sync)
  </what-built>
  <how-to-verify>
    Start the app with `npx expo start` on physical iPhone.

    **Test 1: Basic workout flow**
    1. On dashboard, tap "Start" on any template card
    2. Verify: workout screen shows with Cancel (left), template name (center), Finish (right)
    3. Verify: all template exercises appear as accordion cards with progress rings
    4. Tap an exercise header to collapse/expand it
    5. Enter weight and reps values in set inputs
    6. Tap the done checkbox on a set -- verify rest timer starts counting down
    7. Wait for timer to complete -- verify haptic feedback felt
    8. Tap Finish -- confirm in modal -- verify navigates back to dashboard

    **Test 2: Set and exercise management**
    1. Start another workout
    2. Swipe left on a set row -- verify delete button appears
    3. Swipe a different row -- verify previous row closes
    4. Delete a set via swipe
    5. Tap "Add Set" -- verify new set copies last set values
    6. Tap "Add Exercise" -- verify exercise picker opens
    7. Select a new exercise -- verify it appears in the workout
    8. Tap "Remove Exercise" on an exercise -- confirm removal

    **Test 3: Rest timer**
    1. Check a set as done -- timer starts
    2. Tap +10s -- verify timer extends
    3. Tap -10s -- verify timer shortens
    4. Check another set on a different exercise -- verify previous timer replaced

    **Test 4: Cancel flow**
    1. Start a workout, make some changes
    2. Tap Cancel -- verify confirmation modal appears
    3. Tap "Discard" -- verify returns to dashboard with no saved data

    **Test 5: Crash recovery**
    1. Start a workout, complete a few sets (must trigger backup save)
    2. Force-kill the app (swipe up from app switcher)
    3. Relaunch the app
    4. Verify: resume modal appears on dashboard showing template name and time
    5. Tap "Resume" -- verify workout screen opens with all previously entered data
    6. Alternatively: tap "Discard" -- verify modal closes and no workout data remains

    **Test 6: Template change detection**
    1. Start a workout
    2. Add or remove an exercise (structural change)
    3. Tap Finish -- confirm
    4. Verify: "Update Template?" modal appears (non-dismissible by tapping overlay)
    5. Tap "Yes, Update" or "No, Keep Original" -- verify workout saves either way
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- Dashboard Start button navigates to workout screen
- Complete workout flow works end-to-end
- Crash recovery detects and restores in-progress workouts
- Offline save queues workouts for later sync
- All 20 WORK requirements addressed
</verification>

<success_criteria>
All 5 phase success criteria met:
1. User can start a workout from template, see exercises, edit sets, add/remove sets and exercises
2. Rest timer triggers on set completion with inline bar, +/-10s, and notification
3. Finish saves to database; template change detection prompts for update
4. Offline support via cached templates and write queue
5. Crash recovery with resume modal on dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/05-active-workout/05-06-SUMMARY.md`
</output>
