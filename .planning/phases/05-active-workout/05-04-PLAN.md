---
phase: 05-active-workout
plan: 04
type: execute
wave: 2
depends_on: ["05-03"]
files_modified:
  - src/components/WorkoutSetRow.tsx
  - src/components/WorkoutExerciseCard.tsx
autonomous: true

must_haves:
  truths:
    - "Set rows support swipe-to-delete with rubberband resistance"
    - "Only one set row can be swiped open at a time"
    - "Exercise cards expand and collapse with tap on header"
    - "Collapsed header shows progress ring + exercise name + chevron"
    - "Expanded card shows set table, rest timer bar, add set, remove exercise"
  artifacts:
    - path: "src/components/WorkoutSetRow.tsx"
      provides: "4-column set row with swipe-to-delete gesture"
      exports: ["WorkoutSetRow"]
      min_lines: 100
    - path: "src/components/WorkoutExerciseCard.tsx"
      provides: "Collapsible accordion exercise card"
      exports: ["WorkoutExerciseCard"]
      min_lines: 150
  key_links:
    - from: "src/components/WorkoutSetRow.tsx"
      to: "react-native-gesture-handler"
      via: "Gesture.Pan for swipe-to-delete"
      pattern: "Gesture\\.Pan"
    - from: "src/components/WorkoutExerciseCard.tsx"
      to: "src/components/ProgressRing.tsx"
      via: "ProgressRing in collapsed header"
      pattern: "import.*ProgressRing"
    - from: "src/components/WorkoutExerciseCard.tsx"
      to: "src/components/RestTimerBar.tsx"
      via: "RestTimerBar in expanded body"
      pattern: "import.*RestTimerBar"
    - from: "src/components/WorkoutExerciseCard.tsx"
      to: "src/components/WorkoutSetRow.tsx"
      via: "WorkoutSetRow for each set in exercise"
      pattern: "import.*WorkoutSetRow"
---

<objective>
Build the two complex workout UI components: WorkoutSetRow (4-column set row with swipe-to-delete gesture) and WorkoutExerciseCard (collapsible accordion card composing ProgressRing, RestTimerBar, and WorkoutSetRow).

Purpose: These are the primary visual building blocks of the workout screen. WorkoutSetRow rebuilds the web's swipe-to-delete with react-native-gesture-handler. WorkoutExerciseCard implements the collapsible accordion pattern with all exercise UI within it.
Output: Two component files in src/components/
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-active-workout/05-CONTEXT.md
@.planning/phases/05-active-workout/05-RESEARCH.md
@src/components/SetRow.tsx
@src/components/ExerciseEditorCard.tsx
@src/components/ProgressRing.tsx
@src/components/RestTimerBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkoutSetRow with swipe-to-delete</name>
  <files>src/components/WorkoutSetRow.tsx</files>
  <action>
    Build a workout-specific set row that extends the template editor's SetRow with:
    - Done checkbox (the template SetRow has delete button instead)
    - Swipe-to-delete gesture (the template SetRow has no swipe)
    - Done state visual treatment (60% opacity, green badge)

    Props:
    ```typescript
    interface WorkoutSetRowProps {
      setNumber: number;
      weight: number;
      reps: number;
      isDone: boolean;
      isRevealed: boolean;  // whether delete button is currently visible
      onWeightChange: (value: number) => void;
      onRepsChange: (value: number) => void;
      onToggleDone: () => void;
      onDelete: () => void;
      onReveal: () => void;   // notify parent this row was swiped open
      onClose: () => void;    // notify parent this row was closed
    }
    ```

    Layout (4-column grid matching web, per locked decision):
    - Column 1: Set number badge (32px wide). Normal: textMuted on bgElevated. Done: textPrimary on success (green badge).
    - Column 2: Weight input (flex:1). decimal-pad keyboard. Same local buffer pattern as existing SetRow for trailing decimals.
    - Column 3: Reps input (flex:1). numeric keyboard.
    - Column 4: Done checkbox (44x44px). Pressable with Ionicons "checkmark-circle" (done) or "ellipse-outline" (not done). Done: success color. Not done: textMuted.
    - Done state: entire row at 0.6 opacity (per locked decision)

    Swipe-to-delete implementation (from RESEARCH.md Pattern 3):
    - Wrap the row content in `GestureDetector` with `Gesture.Pan()`
    - Use `useSharedValue` for translateX, `useAnimatedStyle` for transform
    - `activeOffsetX([-10, 10])` -- 10px dead zone before activating (prevents conflict with scroll)
    - `failOffsetY([-5, 5])` -- fail if vertical movement > 5px (let ScrollView take over)
    - `onUpdate`: constrain to left-only swipe. Max drag = -80px. Beyond -80px: rubberband resistance (overDrag * 0.2)
    - `onEnd`: snap to revealed (-70px) or back (0) based on threshold (-40px or velocityX < -500). Use `withSpring({ damping: 20, stiffness: 200 })`
    - When snapping to revealed: call `onReveal()` via `runOnJS`
    - When snapping back: call `onClose()` via `runOnJS`
    - Delete button: positioned behind the row (absolute, right:0), 70px wide, danger background, trash icon. On press: call `onDelete()`
    - When `isRevealed` changes to false externally (another row opened): animate translateX back to 0 with `withSpring`

    Use a `useEffect` watching `isRevealed` to reset translateX when another row opens:
    ```typescript
    useEffect(() => {
      if (!isRevealed && translateX.value !== 0) {
        translateX.value = withSpring(0, { damping: 20, stiffness: 200 });
      }
    }, [isRevealed]);
    ```

    Column headers: NOT in this component -- they go in WorkoutExerciseCard above the set rows. Headers: "#" / "lbs" / "Reps" / checkmark icon.

    Weight input uses the same local buffer pattern as the existing SetRow (editingWeight state, focus/change/blur handlers with Math.round(v*10)/10).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - WorkoutSetRow.tsx exports WorkoutSetRow
    - Component uses Gesture.Pan from react-native-gesture-handler
    - Component uses useSharedValue, useAnimatedStyle, withSpring from react-native-reanimated
    - Done state applies 0.6 opacity and green badge
  </verify>
  <done>
    - WorkoutSetRow renders 4-column grid with done checkbox
    - Swipe-to-delete works with rubberband resistance and snap threshold
    - Only one row can be revealed at a time (coordinated via isRevealed prop)
    - Done state shows 60% opacity and green set number badge
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WorkoutExerciseCard accordion component</name>
  <files>src/components/WorkoutExerciseCard.tsx</files>
  <action>
    Build the collapsible accordion exercise card that composes ProgressRing, WorkoutSetRow, and RestTimerBar.

    Props:
    ```typescript
    interface WorkoutExerciseCardProps {
      exercise: WorkoutExercise;  // from useWorkoutState types
      exerciseIndex: number;
      // Set handlers
      onWeightChange: (exerciseIndex: number, setIndex: number, weight: number) => void;
      onRepsChange: (exerciseIndex: number, setIndex: number, reps: number) => void;
      onToggleDone: (exerciseIndex: number, setIndex: number) => void;
      onAddSet: (exerciseIndex: number) => void;
      onDeleteSet: (exerciseIndex: number, setIndex: number) => void;
      onRemoveExercise: (exerciseIndex: number) => void;
      // Timer props
      timerRemaining: number;
      timerTotal: number;
      isTimerActive: boolean;
      onAdjustTimer: (delta: number) => void;
      // Swipe coordination
      revealedSetKey: string | null;
      onSetReveal: (key: string) => void;
      onSetClose: (key: string) => void;
    }
    ```

    State:
    - `isExpanded: boolean` (default: true for first exercise, true for all -- per "no auto-expand/collapse, user controls")
    - Actually default ALL to expanded (user collapses manually). The web app starts all expanded.

    Collapsed header (always visible, tappable):
    - Horizontal row: ProgressRing (completed/total sets) + exercise name + category badge + chevron (down when collapsed, up when expanded)
    - ProgressRing: completed = sets.filter(s => s.is_done).length, total = sets.length
    - Exercise name: textPrimary, semibold, flex:1, numberOfLines=1
    - Category badge: textMuted, sizes.xs
    - Chevron: Ionicons "chevron-down" or "chevron-up", textSecondary
    - Tap toggles isExpanded

    Expanded body (visible when isExpanded=true):
    - Use `LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut)` before toggling isExpanded for smooth animation (per RESEARCH.md Pitfall 8 recommendation)
    - Column headers row: "#" / "lbs" / "Reps" / checkmark icon (Ionicons "checkmark", textMuted, sizes.xs)
    - Set rows: map exercise.sets to WorkoutSetRow components
      - key: `${exerciseIndex}-${set.set_number}`
      - isRevealed: `revealedSetKey === ${exerciseIndex}-${setIndex}`
      - onReveal: `onSetReveal(${exerciseIndex}-${setIndex})`
      - onClose: `onSetClose(${exerciseIndex}-${setIndex})`
    - RestTimerBar below set rows (only visible in expanded state):
      - remainingSeconds: timerRemaining
      - totalSeconds: timerTotal
      - isActive: isTimerActive
      - onAdjust: onAdjustTimer
    - "Add Set" button: accent border, accent text, centered (same style as ExerciseEditorCard)
    - "Remove Exercise" button: danger text, no background, at the bottom of the card. On press: show Alert.alert confirmation ("Remove Exercise?", "Remove {name} from this workout?", Cancel/Remove)

    Card container: bgSurface background, radii.lg border radius, border (1px, border color), padding, marginBottom.

    IMPORTANT: No reorder controls (no up/down arrows). Per research discretion recommendation: "DO NOT add exercise-level reordering mid-workout."
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - WorkoutExerciseCard.tsx exports WorkoutExerciseCard
    - Component imports and uses ProgressRing, WorkoutSetRow, RestTimerBar
    - Accordion expand/collapse uses LayoutAnimation
    - No reorder controls present
  </verify>
  <done>
    - Collapsible accordion card with progress ring in header
    - Expanded body shows set table, rest timer bar, add set, remove exercise
    - LayoutAnimation provides smooth expand/collapse transitions
    - Swipe coordination passes through to WorkoutSetRow children
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` -- both components type-check
- WorkoutSetRow uses gesture handler + reanimated for swipe
- WorkoutExerciseCard composes ProgressRing, WorkoutSetRow, RestTimerBar
- No reorder controls (per discretion recommendation)
- Done state styling matches web (60% opacity, green badge)
</verification>

<success_criteria>
- WorkoutSetRow has functional swipe-to-delete with rubberband and snap
- WorkoutExerciseCard has working accordion with LayoutAnimation
- Collapsed header shows at-a-glance progress via ProgressRing
- Expanded body has full set editing, timer bar, add/remove controls
- Both components are ready for workout screen composition
</success_criteria>

<output>
After completion, create `.planning/phases/05-active-workout/05-04-SUMMARY.md`
</output>
