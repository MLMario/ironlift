---
phase: 02-authentication
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - app/sign-in.tsx
  - src/components/LoginForm.tsx
  - src/components/RegisterForm.tsx
  - src/components/ResetPasswordForm.tsx
  - src/components/EmailVerificationModal.tsx
autonomous: true

must_haves:
  truths:
    - "User sees IronLift brand header (white 'Iron' + accent blue 'Lift') above the auth card"
    - "User can switch between Login and Register tabs"
    - "Login form has email + password fields with 'Forgot password?' link"
    - "Register form has email + password + confirm password fields with 'Minimum 6 characters' hint"
    - "Tapping 'Forgot password?' shows Reset Password form (tabs hidden, 'Back to login' link)"
    - "Reset Password form has email field and shows green success box when email is sent"
    - "After successful registration, 'Check Your Email' modal appears"
    - "Dismissing email verification modal switches to Login tab"
    - "Client-side validation shows red error box for empty fields, password mismatch, min length"
    - "Server-side Supabase errors show in same red error box"
    - "Loading state shows spinner in submit button"
  artifacts:
    - path: "app/sign-in.tsx"
      provides: "Auth screen with internal state machine (login/register/reset)"
      exports: ["default"]
      contains: "authView"
    - path: "src/components/LoginForm.tsx"
      provides: "Login form with email + password"
      exports: ["LoginForm"]
    - path: "src/components/RegisterForm.tsx"
      provides: "Register form with email + password + confirm password"
      exports: ["RegisterForm"]
    - path: "src/components/ResetPasswordForm.tsx"
      provides: "Reset password form with email + success state"
      exports: ["ResetPasswordForm"]
    - path: "src/components/EmailVerificationModal.tsx"
      provides: "Check Your Email modal after registration"
      exports: ["EmailVerificationModal"]
  key_links:
    - from: "app/sign-in.tsx"
      to: "src/services/auth.ts"
      via: "auth.login, auth.register, auth.resetPassword calls"
      pattern: "auth\\.(login|register|resetPassword)"
    - from: "app/sign-in.tsx"
      to: "src/components/LoginForm.tsx"
      via: "conditional render based on authView state"
      pattern: "LoginForm"
    - from: "app/sign-in.tsx"
      to: "src/components/AuthCard.tsx"
      via: "wraps form content"
      pattern: "AuthCard"
    - from: "src/components/LoginForm.tsx"
      to: "src/components/TextInputField.tsx"
      via: "form field composition"
      pattern: "TextInputField"
---

<objective>
Build the sign-in screen as a single screen with internal state management for login, register, and reset password sub-views. Mirrors the web app's AuthSurface pattern.

Purpose: This is the main auth screen users interact with. It handles account creation (AUTH-01), login (AUTH-03), email verification display (AUTH-02), password reset request (AUTH-07), and client-side validation with error feedback.

Output: Fully functional sign-in screen with three sub-views and email verification modal.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-CONTEXT.md
@.planning/phases/02-authentication/02-RESEARCH.md
@.planning/phases/02-authentication/02-01-SUMMARY.md
@.planning/phases/02-authentication/02-02-SUMMARY.md

@src/services/auth.ts
@src/hooks/useAuth.ts
@src/components/TextInputField.tsx
@src/components/ErrorBox.tsx
@src/components/SuccessBox.tsx
@src/components/SubmitButton.tsx
@src/components/AuthCard.tsx
@src/components/AuthTabs.tsx
@src/theme/tokens.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LoginForm, RegisterForm, ResetPasswordForm, EmailVerificationModal</name>
  <files>src/components/LoginForm.tsx, src/components/RegisterForm.tsx, src/components/ResetPasswordForm.tsx, src/components/EmailVerificationModal.tsx</files>
  <action>
**Reference:** Web app's LoginForm.tsx, RegisterForm.tsx, ResetPasswordForm.tsx components. Match field structure and behavior exactly per CONTEXT.md locked decisions.

**1. LoginForm.tsx:**
- Props: `email: string`, `password: string`, `onEmailChange: (text: string) => void`, `onPasswordChange: (text: string) => void`, `error: string | null`, `loading: boolean`, `onSubmit: () => void`, `onForgotPassword: () => void`
- Layout (top to bottom):
  - ErrorBox (shows if error is truthy)
  - TextInputField for email (label: "Email", keyboardType: email-address, autoCapitalize: none, autoComplete: email)
  - TextInputField for password (label: "Password", secureTextEntry: true)
  - "Forgot password?" link -- right-aligned, `accent` color, `sizes.sm` font. This is a Pressable with text, NOT inside the password field.
  - SubmitButton (title: "Sign In", loading prop, onPress: onSubmit)
- Gap between fields: `spacing.md` (16px)

**2. RegisterForm.tsx:**
- Props: `email: string`, `password: string`, `confirmPassword: string`, `onEmailChange: (text: string) => void`, `onPasswordChange: (text: string) => void`, `onConfirmPasswordChange: (text: string) => void`, `error: string | null`, `loading: boolean`, `onSubmit: () => void`
- Layout (top to bottom):
  - ErrorBox
  - TextInputField for email (same as login)
  - TextInputField for password (secureTextEntry: true, hint: "Minimum 6 characters")
  - TextInputField for confirm password (label: "Confirm Password", secureTextEntry: true)
  - SubmitButton (title: "Create Account", loading, onPress: onSubmit)
- Gap between fields: `spacing.md`

**3. ResetPasswordForm.tsx:**
- Props: `email: string`, `onEmailChange: (text: string) => void`, `error: string | null`, `successMessage: string | null`, `loading: boolean`, `resetEmailSent: boolean`, `onSubmit: () => void`, `onBackToLogin: () => void`
- Layout:
  - "Back to login" link at top -- left-aligned, `accent` color, `sizes.sm` font (Pressable text)
  - Title: "Reset Password" in `textPrimary`, `sizes.xl` (20px), `weights.semibold`, centered
  - If `resetEmailSent` is true: show SuccessBox with "Password reset email sent. Check your inbox." and hide the form below
  - If NOT sent:
    - ErrorBox
    - TextInputField for email
    - SubmitButton (title: "Send Reset Email", loading, onPress: onSubmit)
  - Gap: `spacing.md`

**4. EmailVerificationModal.tsx:**
- Props: `visible: boolean`, `onDismiss: () => void`
- Use React Native's `Modal` component (transparent, animationType: 'fade')
- Overlay: semi-transparent black background (rgba(0,0,0,0.6))
- Modal content card: `bgSurface` background, `radii.lg` corners, `spacing.lg` padding, centered on screen
- Title: "Check Your Email" in `textPrimary`, `sizes.xl`, `weights.semibold`, centered
- Body: Two paragraphs in `textSecondary`, `sizes.base`:
  - "We've sent a confirmation link to your email address."
  - "Please click the link in the email to activate your account before logging in."
- Button: SubmitButton (title: "Got it", onPress: onDismiss)
- Gap between elements: `spacing.md`

All components: Use `StyleSheet.create()` for styles. Use `useTheme()` for all colors/spacing. No inline styles except dynamic values.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. All four component files compile without type errors.
  </verify>
  <done>
Four form components created: LoginForm with email/password and forgot password link, RegisterForm with confirm password and hint, ResetPasswordForm with success state, EmailVerificationModal with "Check Your Email" content. All use reusable components from Plan 02.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build sign-in screen with auth state machine</name>
  <files>app/sign-in.tsx</files>
  <action>
**Reference:** Web app's AuthSurface.tsx state machine pattern. CONTEXT.md locked decisions define exact behavior.

**Rebuild `app/sign-in.tsx`** (replace placeholder entirely) with:

**1. State management:**
- `authView`: `'login' | 'register' | 'reset'` (default: `'login'`)
- `email`, `password`, `confirmPassword`: string state for form fields
- `error`: `string | null` for error messages
- `loading`: boolean for async operations
- `resetEmailSent`: boolean for reset success state
- `showEmailConfirmModal`: boolean for post-registration modal

**2. Screen layout (top to bottom):**
- Wrap entire content in `KeyboardAvoidingView` with `behavior="padding"` (iOS) wrapping a `ScrollView` with `contentContainerStyle={{ flexGrow: 1, justifyContent: 'center' }}` and `keyboardShouldPersistTaps="handled"`
- SafeAreaView with `bgPrimary` background
- Brand header (outside AuthCard):
  - "IronLift" title: "Iron" in `textPrimary` (white) + "Lift" in `accent` (blue). Use a single Text with nested Text elements for split coloring. Font: `sizes['3xl']` (32px), `weights.semibold`
  - Tagline: "Track. Train. Transform." in `textMuted`, `sizes.sm`, below title
  - Center-aligned, `spacing.xl` margin bottom
- AuthCard wrapping form content:
  - If authView is 'login' or 'register': show AuthTabs with activeTab and onTabChange
  - Content area: render LoginForm, RegisterForm, or ResetPasswordForm based on authView
  - If authView is 'login' or 'register': show footer text ("Don't have an account? Sign up" / "Already have an account? Log in") with accent-colored link

**3. State transitions (matching web app's switchAuthSurface):**
- Tab change: clear error, clear password fields, set authView. Keep email when switching between login/register.
- "Forgot password?": set authView to 'reset', clear error, clear password fields
- "Back to login": set authView to 'login', clear error, clear resetEmailSent

**4. Form handlers:**
- `handleLogin`: validate empty fields (set error if empty), call `auth.login(email, password)`. If error, set error message. If success, auth state change triggers navigation automatically (Stack.Protected handles it).
- `handleRegister`: validate empty fields, validate password min length 6, validate password === confirmPassword. Call `auth.register(email, password)`. If error, set error. If success, show EmailVerificationModal, clear form fields.
- `handleResetPassword`: validate empty email. Call `auth.resetPassword(email)`. If error, set error. If success, set resetEmailSent = true.
- All handlers: set loading=true before async call, set loading=false in finally block.

**5. Email verification modal:**
- `onDismiss`: hide modal, switch to login tab, clear form

**6. Error handling:**
- Client-side validation errors: set `error` state directly
- Supabase errors: extract `result.error.message` and set as `error`
- All errors: form stays filled, user can retry immediately (locked decision)

Import `auth` from `@/services/auth`. Import all components from `@/components/`.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. No type errors. Verify sign-in.tsx has all three sub-views (login/register/reset) and the email verification modal.
  </verify>
  <done>
sign-in.tsx is a complete auth screen with: brand header ("Iron" white + "Lift" blue), AuthCard with AuthTabs, three internal sub-views (login/register/reset), email verification modal, client-side validation, Supabase error handling, loading states, and keyboard avoidance. State machine mirrors web app's AuthSurface.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. sign-in.tsx renders brand header, auth card with tabs, and appropriate form
3. LoginForm has "Forgot password?" link
4. RegisterForm has "Minimum 6 characters" hint
5. ResetPasswordForm shows success state when email is sent
6. EmailVerificationModal appears after successful registration
7. Error handling shows red error box for both client and server errors
8. Loading state shows spinner in submit button
</verification>

<success_criteria>
- Sign-in screen manages login/register/reset as internal state transitions (single screen, no router navigation between forms)
- Brand header shows "Iron" (white) + "Lift" (blue accent) with tagline
- All locked decisions from CONTEXT.md implemented: tabbed toggle, forgot password link position, error display, password hint, loading spinner, form stays filled on error
- Forms use reusable components from Plan 02
- Auth operations call service from Plan 01
- Email verification modal mirrors web app behavior
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-03-SUMMARY.md`
</output>
