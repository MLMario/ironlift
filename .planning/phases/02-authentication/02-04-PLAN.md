---
phase: 02-authentication
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - app/reset-password.tsx
  - src/components/SetNewPasswordForm.tsx
autonomous: false

must_haves:
  truths:
    - "Deep link ironlift://reset-password#access_token=...&refresh_token=... opens the Set New Password screen"
    - "Tokens from URL hash fragment are extracted and used to establish a Supabase session via setSession()"
    - "User can enter new password + confirm password and submit to update their password"
    - "Expired/invalid reset link shows error in red box with 'Request New Link' button"
    - "Successful password update shows green success box with 'Back to Login' button"
    - "Password hint 'Minimum 6 characters' is shown below password fields"
  artifacts:
    - path: "app/reset-password.tsx"
      provides: "Set New Password screen (deep link target)"
      exports: ["default"]
      contains: "setSession"
    - path: "src/components/SetNewPasswordForm.tsx"
      provides: "New password + confirm password form"
      exports: ["SetNewPasswordForm"]
  key_links:
    - from: "app/reset-password.tsx"
      to: "src/lib/supabase.ts"
      via: "supabase.auth.setSession() for token establishment"
      pattern: "supabase\\.auth\\.setSession"
    - from: "app/reset-password.tsx"
      to: "expo-linking"
      via: "Linking.useURL() for deep link URL"
      pattern: "useURL"
    - from: "app/reset-password.tsx"
      to: "src/services/auth.ts"
      via: "auth.updateUser() for password update"
      pattern: "auth\\.updateUser"
---

<objective>
Build the Set New Password screen triggered by the password reset deep link, including URL hash fragment token extraction and session establishment. Includes human verification of the complete auth flow.

Purpose: Completes the password reset flow (AUTH-07, AUTH-08). When a user clicks the reset link in their email, Supabase redirects to `ironlift://reset-password#access_token=...`. This screen extracts the tokens, establishes a session, and lets the user set a new password.

Output: Working reset-password screen with deep link handling, plus end-to-end verification of all auth flows.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-CONTEXT.md
@.planning/phases/02-authentication/02-RESEARCH.md
@.planning/phases/02-authentication/02-01-SUMMARY.md
@.planning/phases/02-authentication/02-02-SUMMARY.md

@src/services/auth.ts
@src/hooks/useAuth.ts
@src/lib/supabase.ts
@src/components/TextInputField.tsx
@src/components/ErrorBox.tsx
@src/components/SuccessBox.tsx
@src/components/SubmitButton.tsx
@src/theme/tokens.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SetNewPasswordForm and reset-password screen with deep link handling</name>
  <files>src/components/SetNewPasswordForm.tsx, app/reset-password.tsx</files>
  <action>
**Reference:** Web app's UpdatePasswordForm.tsx for form structure. CONTEXT.md locked decisions for error/success behavior.

**1. SetNewPasswordForm.tsx:**
- Props: `password: string`, `confirmPassword: string`, `onPasswordChange: (text: string) => void`, `onConfirmPasswordChange: (text: string) => void`, `error: string | null`, `loading: boolean`, `onSubmit: () => void`
- Layout (top to bottom):
  - Title: "Set New Password" in `textPrimary`, `sizes.xl`, `weights.semibold`, centered
  - Subtitle: "Enter your new password below." in `textSecondary`, `sizes.sm`, centered
  - ErrorBox (shows if error is truthy)
  - TextInputField for new password (label: "New Password", secureTextEntry: true, hint: "Minimum 6 characters")
  - TextInputField for confirm password (label: "Confirm Password", secureTextEntry: true)
  - SubmitButton (title: "Update Password", loading, onPress: onSubmit)
- Gap between fields: `spacing.md`
- Use `StyleSheet.create()` and `useTheme()` for all styling

**2. reset-password.tsx** (replace placeholder):

**Deep link token extraction:**
- Use `Linking.useURL()` from `expo-linking` to get the full URL including hash fragment
- Create a helper function `extractTokensFromUrl(url: string)` that:
  - Finds the `#` in the URL
  - Parses the hash fragment with `new URLSearchParams(url.substring(hashIndex + 1))`
  - Returns `{ accessToken, refreshToken, type }` (all string | null)
- On mount (useEffect triggered by URL), extract tokens and call `supabase.auth.setSession({ access_token, refresh_token })`
- If `setSession()` fails: set `tokenError` state with the error message
- If `setSession()` succeeds: set `sessionEstablished = true`

**Screen states:**
1. **Loading** (initial, while establishing session): Show centered ActivityIndicator on bgPrimary background
2. **Token error** (expired/invalid link): Show AuthCard containing:
   - ErrorBox with error message (e.g., "This reset link has expired or is invalid.")
   - "Request New Link" SubmitButton (variant: 'primary') that navigates to sign-in screen (the reset form there lets them request a new link). Use `router.replace('/sign-in')`.
3. **Session established, form visible**: Show brand header + AuthCard containing SetNewPasswordForm
4. **Password updated successfully**: Show AuthCard containing:
   - SuccessBox with "Password updated successfully!"
   - "Back to Login" SubmitButton that calls `router.replace('/sign-in')`

**Form handler (handlePasswordUpdate):**
- Validate: passwords match, min length 6
- Call `auth.updateUser(password)` from auth service
- If error, set error state
- If success, set `passwordUpdated = true`

**State variables:**
- `url` from `Linking.useURL()`
- `tokenError: string | null` -- error from setSession
- `sessionEstablished: boolean` -- true after successful setSession
- `password, confirmPassword: string` -- form fields
- `error: string | null` -- form validation/submission error
- `loading: boolean` -- async operation in progress
- `passwordUpdated: boolean` -- success state

**Layout:**
- SafeAreaView with bgPrimary background
- KeyboardAvoidingView + ScrollView (same pattern as sign-in)
- Brand header (same "Iron"+"Lift" pattern as sign-in -- can duplicate or extract)
- AuthCard wrapping the form content

**Important edge cases:**
- If no URL or no tokens in URL: show error state ("No reset link found. Please request a new password reset email.") with "Request New Link" button
- Do NOT navigate away automatically on success -- let user tap "Back to Login" (per CONTEXT.md: user stays on form, can retry)
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. No type errors. Verify reset-password.tsx handles all four states: loading, token error, form, success.
  </verify>
  <done>
reset-password.tsx handles the full deep link flow: extracts tokens from URL hash fragment, establishes Supabase session via setSession(), shows Set New Password form on success, shows error + "Request New Link" on expired/invalid link, shows success message after password update. SetNewPasswordForm matches locked decisions for password hint and validation.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete authentication system for IronLift:
- Auth service (register, login, logout, reset password, update password)
- AuthProvider with session persistence and AppState auto-refresh
- Root layout with real auth guard and splash screen hold
- Sign-in screen with Login/Register tabs and Reset Password sub-view
- Reset password deep link screen with token extraction
- Email verification modal after registration
- Reusable form components (TextInputField, ErrorBox, SuccessBox, SubmitButton, AuthCard, AuthTabs)
  </what-built>
  <how-to-verify>
**Prerequisites:** Ensure your Supabase project has:
1. `ironlift://reset-password` added to Authentication > URL Configuration > Redirect URLs
2. Email confirmations enabled in Authentication > Providers > Email
3. Valid .env with EXPO_PUBLIC_SUPABASE_URL and EXPO_PUBLIC_SUPABASE_ANON_KEY

**Test on physical iPhone via Expo Go:**

1. **App launch (session check):**
   - Kill and restart the app
   - Verify: splash screen shows briefly, then sign-in screen appears (no flash of dashboard)

2. **Sign-in screen visual:**
   - Verify: "IronLift" brand header with "Iron" in white and "Lift" in blue accent
   - Verify: "Track. Train. Transform." tagline below
   - Verify: Auth card with Login/Register tabs, Login tab active by default
   - Verify: Dark theme matches web app colors

3. **Login form:**
   - Verify: Email + Password fields with labels
   - Verify: Password field has eye icon toggle (tap to show/hide password)
   - Verify: "Forgot password?" link right-aligned
   - Tap "Sign In" with empty fields -> red error box appears
   - Enter wrong credentials -> Supabase error in red error box
   - Verify: Form stays filled after error

4. **Register form:**
   - Tap "Register" tab
   - Verify: Email + Password + Confirm Password fields
   - Verify: "Minimum 6 characters" hint below password field
   - Enter mismatched passwords -> "Passwords do not match" error
   - Register with valid email -> "Check Your Email" modal appears
   - Tap "Got it" -> switches to Login tab

5. **Reset password flow:**
   - Tap "Forgot password?" from login
   - Verify: Tabs hidden, "Back to login" link at top, "Reset Password" title
   - Enter email and submit -> green success box "Password reset email sent..."
   - Tap "Back to login" -> returns to login tab

6. **Keyboard behavior:**
   - Tap email/password fields
   - Verify: keyboard does not cover the input fields (KeyboardAvoidingView working)

7. **Login success (if you have a verified account):**
   - Log in with valid credentials
   - Verify: navigates to dashboard (index screen)

8. **Session persistence (if logged in):**
   - Kill and restart the app
   - Verify: goes directly to dashboard (no sign-in screen)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found during testing</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Deep link token extraction correctly parses hash fragments (not query params)
3. Expired/invalid reset link shows error + "Request New Link" button
4. Successful password update shows success message + "Back to Login" button
5. All auth flows work on physical device via Expo Go
6. Session persists across app kills
7. No auth screen flash on app launch
</verification>

<success_criteria>
- Password reset deep link flow works end-to-end (AUTH-07, AUTH-08)
- Token extraction handles URL hash fragments correctly
- Expired link shows meaningful error with recovery path
- All auth screens match web app visual design (dark theme, spacing, typography)
- Session persists across app restarts (AUTH-04)
- Auth guard prevents dashboard access without login
- Splash screen prevents auth screen flash
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-04-SUMMARY.md`
</output>
