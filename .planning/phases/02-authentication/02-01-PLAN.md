---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase.ts
  - src/services/auth.ts
  - src/hooks/useAuth.ts
  - app/_layout.tsx
autonomous: true
user_setup:
  - service: supabase
    why: "Password reset deep link must be whitelisted"
    dashboard_config:
      - task: "Add ironlift://reset-password to Redirect URLs"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Redirect URLs"
      - task: "Verify email confirmations are enabled"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email -> Enable email confirmations = ON"
      - task: "Verify minimum password length is 6"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email -> Minimum password length = 6"

must_haves:
  truths:
    - "Auth state (session, user, isLoading, isLoggedIn) is available app-wide via useAuth() hook"
    - "App shows splash screen during initial session check, then navigates to sign-in or dashboard"
    - "Session tokens auto-refresh when app returns to foreground"
    - "Auth service provides register, login, logout, resetPassword, updateUser matching AuthService interface"
  artifacts:
    - path: "src/services/auth.ts"
      provides: "Auth service with all AuthService interface methods"
      exports: ["auth"]
      contains: "resetPasswordForEmail"
    - path: "src/hooks/useAuth.ts"
      provides: "AuthProvider context and useAuth hook"
      exports: ["AuthProvider", "useAuth"]
      contains: "onAuthStateChange"
    - path: "src/lib/supabase.ts"
      provides: "Supabase client with AppState auto-refresh"
      contains: "startAutoRefresh"
    - path: "app/_layout.tsx"
      provides: "Root layout with AuthProvider and splash screen hold"
      contains: "AuthProvider"
  key_links:
    - from: "src/hooks/useAuth.ts"
      to: "src/lib/supabase.ts"
      via: "supabase.auth.getSession + onAuthStateChange"
      pattern: "supabase\\.auth\\.(getSession|onAuthStateChange)"
    - from: "app/_layout.tsx"
      to: "src/hooks/useAuth.ts"
      via: "AuthProvider wrapping + useAuth() consumption"
      pattern: "(AuthProvider|useAuth)"
    - from: "src/services/auth.ts"
      to: "src/lib/supabase.ts"
      via: "supabase.auth method calls"
      pattern: "supabase\\.auth\\."
---

<objective>
Create the auth infrastructure layer: auth service (ported from web app), AuthProvider context with session management, AppState auto-refresh, and root layout rewiring with splash screen hold.

Purpose: Establishes the auth state management foundation that all auth UI screens consume. Without this, there is no session state, no auth guard, and no way for the UI to know if the user is logged in.

Output: Working auth service, AuthProvider with useAuth() hook, updated root layout with real auth guard and splash screen hold during session check.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-RESEARCH.md

@src/lib/supabase.ts
@src/types/services.ts
@src/theme/index.ts
@app/_layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Port auth service and add AppState auto-refresh</name>
  <files>src/services/auth.ts, src/lib/supabase.ts</files>
  <action>
1. **Add AppState auto-refresh to `src/lib/supabase.ts`:**
   - Import `AppState` from `react-native`
   - Add AppState listener at module level (after client creation) that calls `supabase.auth.startAutoRefresh()` when state is `'active'` and `supabase.auth.stopAutoRefresh()` otherwise
   - This is the official Supabase pattern for non-browser environments

2. **Create `src/services/auth.ts`** by copying from web app (`exercise_tracker_app/packages/shared/src/services/auth.ts`) with these changes:
   - Import path: `import { supabase } from '@/lib/supabase'` (instead of `'../lib/supabase'`)
   - Import `* as Linking from 'expo-linking'` for deep link URL generation
   - Import types from `@/types/services` (instead of `'../types/services'`)
   - In `resetPassword()`: replace `window.location.origin + window.location.pathname` with `Linking.createURL('reset-password')` which generates `ironlift://reset-password`
   - Remove any `window.*` references (none expected outside resetPassword)
   - Keep ALL other functions identical to web app: `register()`, `login()`, `logout()`, `updateUser()`, `getCurrentUser()`, `getSession()`, `onAuthStateChange()`
   - Export as `export const auth: AuthService = { ... }` matching the interface in `src/types/services.ts`

Do NOT change validation logic, error handling patterns, or return types. The web app's auth service is the canonical reference.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. No type errors in auth.ts or supabase.ts. The auth service must satisfy the AuthService interface from types/services.ts.
  </verify>
  <done>
src/services/auth.ts exports an `auth` object implementing all AuthService methods. src/lib/supabase.ts has AppState auto-refresh listener. Both files compile without type errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AuthProvider context and useAuth hook</name>
  <files>src/hooks/useAuth.ts</files>
  <action>
Create `src/hooks/useAuth.ts` with:

1. **AuthContextType interface:**
   - `session: Session | null`
   - `user: User | null`
   - `isLoading: boolean` (true until initial session check completes)
   - `isLoggedIn: boolean`

2. **AuthContext** with `createContext<AuthContextType>` and sensible defaults: `session: null, user: null, isLoading: true, isLoggedIn: false`

3. **AuthProvider component:**
   - State: `session` (Session | null), `isLoading` (boolean, default true)
   - On mount effect: call `supabase.auth.getSession()`, set session from result, set `isLoading = false`
   - On mount effect: call `supabase.auth.onAuthStateChange()`, update session on every event. Return cleanup that calls `subscription.unsubscribe()`
   - IMPORTANT: Do NOT call any Supabase auth methods inside the onAuthStateChange callback (causes deadlocks per Supabase docs). Only set React state.
   - Derive `user` from `session?.user ?? null`
   - Derive `isLoggedIn` from `!!session`
   - Render `<AuthContext.Provider value={value}>{children}</AuthContext.Provider>`

4. **useAuth hook:** `export function useAuth() { return useContext(AuthContext); }`

Import `supabase` directly from `@/lib/supabase` (NOT from the auth service -- AuthProvider is lower-level than the service).
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. No type errors. Verify useAuth.ts exports both `AuthProvider` and `useAuth`.
  </verify>
  <done>
src/hooks/useAuth.ts exports AuthProvider component and useAuth hook. AuthProvider manages session state via getSession + onAuthStateChange. isLoading starts true and becomes false after initial check.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire AuthProvider into root layout with splash screen hold</name>
  <files>app/_layout.tsx</files>
  <action>
Rewrite `app/_layout.tsx` to integrate real auth:

1. **Imports:**
   - Add: `import * as SplashScreen from 'expo-splash-screen'`
   - Add: `import { AuthProvider, useAuth } from '@/hooks/useAuth'`
   - Keep: existing ThemeProvider import

2. **Splash screen hold:**
   - Call `SplashScreen.preventAutoHideAsync()` at module level (outside component)

3. **RootLayoutNav function:**
   - Replace `const isLoggedIn = true` with `const { isLoggedIn, isLoading } = useAuth()`
   - Add `useEffect` that calls `SplashScreen.hideAsync()` when `isLoading` becomes false
   - If `isLoading` is true, return `null` (splash screen is still visible, no UI flash)
   - Keep existing Stack configuration and screen options

4. **Stack.Protected guards:**
   - `!isLoggedIn` guard group: `sign-in` and `reset-password` screens
   - `isLoggedIn` guard group: `index`, `template-editor`, `workout`, `settings`
   - Remove `create-account` from the Stack (register is internal to sign-in screen now)
   - Add `reset-password` screen to the `!isLoggedIn` guard group

5. **RootLayout default export:**
   - Wrap `<ThemeProvider>` around `<AuthProvider>` around `<RootLayoutNav />`
   - Order: ThemeProvider > AuthProvider > RootLayoutNav

6. **Delete `app/create-account.tsx`** -- register is now an internal tab on sign-in, not a separate route.

7. **Remove** the Phase 1 `supabase.auth.getSession()` connection test in the useEffect (AuthProvider now handles session).
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. No type errors. Verify `app/create-account.tsx` no longer exists. Run `npx expo export --platform ios --no-minify 2>&1 | head -20` (or `npx expo start` dry check) to verify the app bundle compiles without errors.
  </verify>
  <done>
Root layout wraps AuthProvider, uses real auth state for Stack.Protected guards, holds splash screen during initial session check, and hides it when isLoading becomes false. create-account.tsx is deleted. No hardcoded isLoggedIn.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/services/auth.ts` implements all methods from AuthService interface
3. `src/hooks/useAuth.ts` exports both AuthProvider and useAuth
4. `app/_layout.tsx` uses useAuth() instead of hardcoded isLoggedIn
5. `app/create-account.tsx` no longer exists
6. `src/lib/supabase.ts` includes AppState auto-refresh
</verification>

<success_criteria>
- Auth service is a direct port from web app with only import path and redirectTo URL changes
- AuthProvider manages session state via getSession + onAuthStateChange
- Root layout prevents auth screen flash via splash screen hold
- Stack.Protected guards use real auth state
- All files compile with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
