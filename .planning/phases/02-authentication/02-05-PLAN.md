---
phase: 02-authentication
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [app/_layout.tsx]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "After successful login, user is navigated to the dashboard screen (index)"
    - "Deep link password reset flow still works (user arrives via ironlift://reset-password, setSession() is called, user stays on reset-password screen to enter new password)"
    - "App launch with no session still shows sign-in screen"
    - "Logout from dashboard still redirects to sign-in screen"
  artifacts:
    - path: "app/_layout.tsx"
      provides: "Correct screen declaration order for Stack.Protected redirect behavior"
      contains: "reset-password.*Screen.*after.*isLoggedIn.*Protected"
  key_links:
    - from: "app/_layout.tsx"
      to: "Expo Router redirect logic"
      via: "Stack.Protected guard evaluation + screen declaration order"
      pattern: "Stack\\.Protected.*isLoggedIn.*index.*reset-password"
---

<objective>
Fix login routing to dashboard by moving the reset-password screen declaration after the isLoggedIn guard group in _layout.tsx.

Purpose: After login, Expo Router scans screen declaration order for the first available (non-protected) screen. Currently reset-password sits between the two guard groups and is found before index. Moving it after the isLoggedIn group ensures index is found first during the redirect scan.

Output: Modified app/_layout.tsx with correct screen declaration order.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/login-routes-to-reset-password.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reorder reset-password screen declaration in root layout</name>
  <files>app/_layout.tsx</files>
  <action>
In app/_layout.tsx, move the `<Stack.Screen name="reset-password" />` declaration (currently at line 40, between the two Stack.Protected groups) to AFTER the isLoggedIn Stack.Protected group.

Current order (BROKEN):
```
<Stack.Protected guard={!isLoggedIn}>
  <Stack.Screen name="sign-in" />
</Stack.Protected>

<Stack.Screen name="reset-password" />   <-- HERE (first unguarded screen found after login)

<Stack.Protected guard={isLoggedIn}>
  <Stack.Screen name="index" />
  ...
</Stack.Protected>
```

New order (FIXED):
```
<Stack.Protected guard={!isLoggedIn}>
  <Stack.Screen name="sign-in" />
</Stack.Protected>

<Stack.Protected guard={isLoggedIn}>
  <Stack.Screen name="index" />
  ...
</Stack.Protected>

<Stack.Screen name="reset-password" />   <-- MOVED: now after isLoggedIn group
```

Update the code comment above the reset-password declaration to explain both WHY it is outside guards AND WHY it must be declared after the isLoggedIn group:

```tsx
{/* Reset password -- outside guards because setSession() during deep link
    recovery flips isLoggedIn mid-flow, which would redirect user away before
    entering new password. Declared AFTER isLoggedIn group so that on normal
    login, Expo Router finds index (first screen in isLoggedIn group) before
    reaching this unguarded screen during its redirect scan. */}
<Stack.Screen name="reset-password" />
```

Why this fixes both scenarios:

1. NORMAL LOGIN: User logs in on sign-in. isLoggedIn becomes true. sign-in guard (!isLoggedIn) becomes false. Expo Router scans for first available screen in declaration order: sign-in (protected, skip) -> index (in isLoggedIn group, guard=true, MATCH) -> routes to index (dashboard). reset-password is never reached because index was found first.

2. DEEP LINK RESET: User opens ironlift://reset-password. Expo Router deep links route directly to the named screen regardless of declaration order. reset-password is unguarded, so it is accessible. setSession() flips isLoggedIn=true, but user is already on the unguarded reset-password screen, so no redirect occurs. User enters new password normally.

Do NOT change any other code in _layout.tsx. Do NOT modify reset-password.tsx or useAuth.tsx. This is a declaration order fix only.
  </action>
  <verify>
1. Read app/_layout.tsx and confirm:
   - reset-password Stack.Screen is declared AFTER the isLoggedIn Stack.Protected block
   - reset-password Stack.Screen is NOT inside any Stack.Protected block
   - index is still the first screen in the isLoggedIn Stack.Protected block
   - sign-in is still in the !isLoggedIn Stack.Protected block
   - The comment above reset-password explains both the guard and ordering rationale

2. Run `npx expo export --platform ios --dump-sourcemap=false 2>&1 | head -5` to confirm the project still compiles without errors (or `npx tsc --noEmit` if available).
  </verify>
  <done>
- reset-password is declared after the isLoggedIn protected group
- No other files or logic changed
- Project compiles without errors
  </done>
</task>

</tasks>

<verification>
After the code change:

1. **Login flow (primary fix):** On sign-in screen, after successful login, Expo Router should redirect to index (dashboard) because index is now the first available screen in declaration order when isLoggedIn=true.

2. **Deep link flow (must not regress):** Opening ironlift://reset-password deep link should still route to the reset-password screen, allow setSession(), and display the password form.

3. **Cold launch (no session):** App should still show sign-in screen (sign-in is in !isLoggedIn group, which is the first available screen when isLoggedIn=false).

4. **Logout:** Tapping logout on dashboard should redirect to sign-in screen (index guard becomes false, sign-in guard becomes true).

Note: Full verification of scenarios 1 and 2 requires on-device testing (UAT retest). Scenario 3 and 4 were already passing in UAT tests 9 and 10.
</verification>

<success_criteria>
- Login redirects to dashboard (index), not reset-password -- fixes UAT test 8
- Deep link password reset flow still works -- no regression on the flow tested in 02-04
- All other auth flows (cold launch, logout, session persistence) unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-05-SUMMARY.md`
</output>
