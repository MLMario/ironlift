---
phase: 03-exercise-library
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/components/ExercisePickerModal.tsx
  - app/index.tsx
autonomous: false

must_haves:
  truths:
    - "Exercise picker modal presents as near-full iOS sheet (pageSheet) with slide animation"
    - "User can search exercises by name with instant filtering on every keystroke"
    - "User can filter exercises by category via horizontal chips"
    - "User can create a custom exercise inline with name and category, duplicate names rejected"
    - "On successful creation, the new exercise auto-selects and the modal closes"
    - "Modal state resets on every open (search cleared, filter to All, create form hidden)"
    - "Already-added exercises appear dimmed and non-tappable"
    - "Custom exercises show green CUSTOM badge"
  artifacts:
    - path: "src/components/ExercisePickerModal.tsx"
      provides: "Reusable exercise picker modal with search, filter, list, and inline create form"
      exports: ["ExercisePickerModal"]
    - path: "app/index.tsx"
      provides: "Dashboard with temporary exercise picker test button"
      contains: "ExercisePickerModal"
  key_links:
    - from: "src/components/ExercisePickerModal.tsx"
      to: "src/hooks/useExercises.ts"
      via: "useExercises hook for data"
      pattern: "useExercises"
    - from: "src/components/ExercisePickerModal.tsx"
      to: "src/components/CategoryChips.tsx"
      via: "CategoryChips component"
      pattern: "CategoryChips"
    - from: "src/components/ExercisePickerModal.tsx"
      to: "src/components/ExerciseListItem.tsx"
      via: "ExerciseListItem + ITEM_HEIGHT"
      pattern: "(ExerciseListItem|ITEM_HEIGHT)"
    - from: "src/components/ExercisePickerModal.tsx"
      to: "src/services/exercises.ts"
      via: "exercises.createExercise for inline form"
      pattern: "exercises\\.createExercise"
    - from: "src/components/ExercisePickerModal.tsx"
      to: "react-native Modal"
      via: "presentationStyle pageSheet"
      pattern: "presentationStyle.*pageSheet"
---

<objective>
Build the ExercisePickerModal -- the main deliverable of Phase 3 -- assembling all sub-components into a reusable picker, then wire it into the dashboard for manual testing.

Purpose: Deliver the reusable exercise picker that will be consumed by the template editor (Phase 4), active workout (Phase 5), and My Exercises screen (Phase 7).
Output: ExercisePickerModal.tsx component and a temporary test hookup on the dashboard.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-exercise-library/03-CONTEXT.md
@.planning/phases/03-exercise-library/03-RESEARCH.md
@.planning/phases/03-exercise-library/03-01-SUMMARY.md
@.planning/phases/03-exercise-library/03-02-SUMMARY.md
@src/types/database.ts
@src/theme/tokens.ts
@app/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build ExercisePickerModal component</name>
  <files>src/components/ExercisePickerModal.tsx</files>
  <action>
Create `src/components/ExercisePickerModal.tsx` -- the central reusable component of Phase 3.

**Props interface:**
```typescript
interface ExercisePickerModalProps {
  visible: boolean;
  excludeIds?: string[];
  onClose: () => void;
  onSelect: (exercise: Exercise) => void;
}
```

The modal manages its own data via useExercises hook and its own create flow via exercises.createExercise. It does NOT receive exercises as a prop -- it loads them internally.

**Modal presentation (LOCKED -- user decision):**
- Use React Native's `<Modal>` component (NOT Expo Router, NOT a custom overlay)
- `animationType="slide"`, `presentationStyle="pageSheet"`, `onRequestClose={onClose}`
- Wrap content in `<SafeAreaView>` with `backgroundColor: theme.colors.bgPrimary` and `flex: 1`

**Layout order top-to-bottom (LOCKED -- user decision):**
1. **Header row:** Title "Select Exercise" (left) + X close button (right, Ionicons "close" icon, size 24, 44px tap target)
2. **Search bar:** TextInput with search icon (Ionicons "search"), placeholder "Search exercises...", `backgroundColor: theme.colors.bgElevated`, `borderRadius: theme.radii.md`. Full width with horizontal padding.
3. **Category chips:** `<CategoryChips>` component with selectedCategory state
4. **Exercise list:** `<FlatList>` rendering `<ExerciseListItem>` components
5. **Create New Exercise button:** Full-width button at the bottom, toggles the inline create form. Text: "Create New Exercise" when form hidden, "Cancel New Exercise" when form shown. Style: outlined button with accent border and text.
6. **Inline create form (conditionally rendered):** Appears below the toggle button when active. Fields: Exercise Name (TextInput) + Category (custom dropdown) + "Create" submit button.

**State management:**
- `searchQuery: string` -- filters exercises by name (case-insensitive includes)
- `selectedCategory: string` -- filters exercises by category ("All" shows all)
- `showCreateForm: boolean` -- toggles inline create form visibility
- `newExerciseName: string` -- create form name input
- `newExerciseCategory: ExerciseCategory` -- create form category selection (default: 'Chest')
- `createError: string | null` -- error message for create form
- `isCreating: boolean` -- loading state for create operation
- `showCategoryDropdown: boolean` -- controls the category picker dropdown visibility

**State reset on open (LOCKED -- user decision):**
Use `useEffect` triggered by `visible` prop. When `visible` becomes true, reset ALL state: searchQuery='', selectedCategory='All', showCreateForm=false, newExerciseName='', newExerciseCategory='Chest', createError=null, isCreating=false, showCategoryDropdown=false.

**Filtering logic (applied via useMemo):**
1. Start with all exercises from useExercises hook
2. If selectedCategory !== 'All', filter by category match
3. If searchQuery is not empty, filter by name.toLowerCase().includes(searchQuery.toLowerCase())
4. Apply excludeIds: mark exercises whose id is in excludeIds as disabled (pass `isDisabled` prop to ExerciseListItem)
5. Do NOT debounce search -- filtering ~1000 items client-side is instant

**FlatList configuration:**
- `data={filteredExercises}`
- `keyExtractor={(item) => item.id}`
- `renderItem` renders `<ExerciseListItem>` with isDisabled based on excludeIds
- `getItemLayout` using ITEM_HEIGHT constant from ExerciseListItem
- `removeClippedSubviews={true}`
- `maxToRenderPerBatch={15}`
- `windowSize={11}`
- `initialNumToRender={15}`
- `ListEmptyComponent`: centered "No exercises found" text (theme.colors.textMuted)
- If isLoading from useExercises, show an `<ActivityIndicator>` instead of the list

**Category dropdown for create form:**
Build a simple custom dropdown (do NOT use @react-native-picker/picker -- not in approved list):
- A `Pressable` showing the currently selected category with a chevron-down icon
- On press, show a small `<Modal>` (or absolutely positioned overlay) with a flat list of the 7 categories from FORM_CATEGORIES
- On category tap, set `newExerciseCategory` and close the dropdown
- Style the dropdown trigger to look like a form input (same style as the name TextInput)

**Create exercise flow (LOCKED -- user decision):**
1. User taps "Create New Exercise" button -> form appears
2. User enters name and selects category
3. User taps "Create" button
4. Validate: name must not be empty (show error "Exercise name is required")
5. Set isCreating=true, clear createError
6. Call `exercises.createExercise(newExerciseName.trim(), newExerciseCategory)`
7. If error contains "already exists", show "An exercise with this name already exists" error
8. If other error, show "Failed to create exercise" error
9. On success: call `onSelect(newExercise)` with the returned exercise -- this auto-selects it AND the parent will close the modal
10. After successful create, also call the useExercises `refresh()` to update the cached list

**Styling:**
- Use `getStyles(theme)` pattern throughout
- Search bar: height 44px, bgElevated background, border radius md, padding horizontal md, search icon inside (positioned absolute left)
- Header: flexDirection row, justifyContent space-between, alignItems center, padding md
- Create button: borderWidth 1, borderColor accent, borderRadius md, minHeight 44, centered text in accent color
- Create form: bgSurface background, padding md, border radius md, gap sm between fields
- Form submit button: bgAccent background, textPrimary color, borderRadius md, minHeight 44
  </action>
  <verify>
   - `npx tsc --noEmit` passes
   - ExercisePickerModal.tsx exports the component
   - Modal uses presentationStyle="pageSheet" and animationType="slide"
   - State resets on visible change (useEffect dependency on visible)
   - FlatList has getItemLayout, removeClippedSubviews, maxToRenderPerBatch, windowSize
  </verify>
  <done>
   - ExercisePickerModal renders with all 6 sections (header, search, chips, list, create button, create form)
   - Search filters exercises on every keystroke
   - Category chips filter exercises by category
   - Create form validates name, rejects duplicates, auto-selects on success
   - Modal state resets on every open
   - Disabled state applied to exercises in excludeIds
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire picker into dashboard for testing</name>
  <files>app/index.tsx</files>
  <action>
Update the dashboard (app/index.tsx) to include a temporary test hookup for the exercise picker modal.

Changes to make:
1. Import `ExercisePickerModal` from `@/components/ExercisePickerModal`
2. Import `useExercises` from `@/hooks/useExercises`
3. Add state: `const [pickerVisible, setPickerVisible] = useState(false)`
4. Add state: `const [selectedExercise, setSelectedExercise] = useState<Exercise | null>(null)` (for displaying selection result)
5. The existing "Exercises" button (which currently does `router.push('/settings/exercises')`) should ALSO open the picker -- change it to `setPickerVisible(true)`
6. Add `<ExercisePickerModal>` at the bottom of the JSX tree:
   ```tsx
   <ExercisePickerModal
     visible={pickerVisible}
     onClose={() => setPickerVisible(false)}
     onSelect={(exercise) => {
       setSelectedExercise(exercise);
       setPickerVisible(false);
     }}
   />
   ```
7. Below the Exercises button, show selected exercise name if one was picked: `{selectedExercise && <Text style={styles.subtitle}>Selected: {selectedExercise.name}</Text>}`

This is a TEMPORARY test hookup. It will be replaced in Phase 4 when the real dashboard is built. Its purpose is to allow manual testing of the picker modal on a physical device.

Keep all existing buttons (Start Workout, Edit Template, Log Out). Just modify the Exercises button behavior and add the modal + selection display.
  </action>
  <verify>
   - `npx tsc --noEmit` passes
   - `npx expo start` launches without errors
   - Dashboard shows "Exercises" button that opens the picker modal
  </verify>
  <done>
   - Dashboard "Exercises" button opens the exercise picker modal
   - Selected exercise name displays on dashboard after selection
   - Picker modal can be dismissed via X button or swipe-down
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Exercise Library: exercise service, cache layer, useExercises hook, CategoryChips, ExerciseListItem, and ExercisePickerModal -- all wired into the dashboard for testing.</what-built>
  <how-to-verify>
1. Open the app in Expo Go on your iPhone
2. Log in and tap the "Exercises" button on the dashboard
3. Verify the picker modal slides up as a near-full sheet (small gap at top, dimmed parent visible)
4. Verify you see a list of exercises (if Supabase has data) or loading indicator
5. Type in the search bar -- verify exercises filter instantly by name
6. Tap category chips (Chest, Back, etc.) -- verify list filters by category
7. Tap "All" chip -- verify all exercises show again
8. Scroll through the exercise list -- verify smooth scrolling with ~1000 items
9. Tap an exercise -- verify it gets selected and the modal closes, selected name shows on dashboard
10. Reopen the picker -- verify state is reset (search cleared, All selected, create form hidden)
11. Tap "Create New Exercise" -- verify inline form appears with name input and category dropdown
12. Try creating with empty name -- verify error message
13. Enter a name, select a category, tap Create -- verify exercise is created and auto-selected
14. Reopen picker and search for your new exercise -- verify it appears with green CUSTOM badge
15. Tap the X button or swipe down -- verify modal dismisses

Note: Steps 4-14 require Supabase to have exercise data. If no data appears, verify Supabase connection and that the exercises table has system exercises populated.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for the entire project
- `npx expo start` launches without errors
- ExercisePickerModal is a standalone reusable component (not a route)
- All CONTEXT.md locked decisions are implemented:
  - Near-full sheet via pageSheet
  - Layout order: Title/X, Search, Chips, List, Create button, Create form
  - Flat list (not sectioned), user exercises first
  - CUSTOM green badge on user exercises
  - Disabled state for already-added exercises
  - "No exercises found" empty state
  - Horizontal chips with All, Chest, Back, Shoulders, Legs, Arms, Core, Other (no Cardio)
  - Inline create form with name + category
  - Duplicate name rejection
  - Auto-select on create
  - State reset on open
</verification>

<success_criteria>
- Exercise picker modal works end-to-end: browse, search, filter, create, select
- Modal is reusable -- receives callbacks, manages its own data
- All user decisions from CONTEXT.md are honored
- No deferred items included (no edit/delete UI, no equipment display, no detail view)
- Phase 3 success criteria met: EXER-01 through EXER-09 (excluding edit/delete UI which is Phase 7)
</success_criteria>

<output>
After completion, create `.planning/phases/03-exercise-library/03-03-SUMMARY.md`
</output>
