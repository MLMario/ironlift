---
phase: 04-templates-and-dashboard
plan: 04
type: execute
wave: 3
depends_on: ["04-01", "04-02", "04-03"]
files_modified:
  - app/template-editor.tsx
autonomous: false

must_haves:
  truths:
    - "User can create a new template with a name and exercises"
    - "User can edit an existing template (name, exercises, sets, rest times)"
    - "User can add exercises via the exercise picker modal"
    - "User can reorder exercises with up/down arrows"
    - "User can remove exercises from a template"
    - "User can add and remove sets per exercise (minimum 1 set)"
    - "User can configure weight, reps, and rest time per exercise"
    - "Template editor validates: name required, at least 1 exercise"
    - "Unsaved changes show discard confirmation when user taps Cancel"
    - "Save creates new template or updates existing, then navigates back"
  artifacts:
    - path: "app/template-editor.tsx"
      provides: "Full template editor modal screen"
      contains: "EditingTemplate"
  key_links:
    - from: "app/template-editor.tsx"
      to: "src/services/templates.ts"
      via: "templates.createTemplate/updateTemplate/getTemplate"
      pattern: "templates\\.(create|update|get)Template"
    - from: "app/template-editor.tsx"
      to: "src/components/ExercisePickerModal.tsx"
      via: "renders ExercisePickerModal for exercise selection"
      pattern: "ExercisePickerModal"
    - from: "app/template-editor.tsx"
      to: "src/components/ExerciseEditorCard.tsx"
      via: "renders ExerciseEditorCard for each exercise"
      pattern: "ExerciseEditorCard"
    - from: "app/template-editor.tsx"
      to: "expo-router"
      via: "useLocalSearchParams for templateId, router.back() on save/cancel"
      pattern: "useLocalSearchParams"
---

<objective>
Build the template editor modal screen that assembles all sub-components into a complete create/edit flow.

Purpose: This is the primary authoring surface where users build and modify their workout templates. It's the most complex screen in the phase, combining state management, validation, the exercise picker, and the exercise editor cards into a scrollable modal form.

Output: Fully functional template editor modal supporting create and edit modes with validation and unsaved changes protection.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-templates-and-dashboard/04-RESEARCH.md
@.planning/phases/04-templates-and-dashboard/04-01-SUMMARY.md
@.planning/phases/04-templates-and-dashboard/04-02-SUMMARY.md
@.planning/phases/04-templates-and-dashboard/04-03-SUMMARY.md
@src/components/ExercisePickerModal.tsx
@src/types/database.ts
@src/types/services.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build template editor screen with state management and full CRUD flow</name>
  <files>app/template-editor.tsx</files>
  <action>
  REPLACE the Phase 1 placeholder in `app/template-editor.tsx` with the full template editor modal.

  **Imports:**
  - React: useState, useEffect, useCallback, useRef
  - React Native: View, Text, TextInput, Pressable, ScrollView, Alert, ActivityIndicator, KeyboardAvoidingView, Platform, StyleSheet
  - SafeAreaView from react-native-safe-area-context
  - useRouter, useLocalSearchParams from expo-router
  - useTheme, Theme from @/theme
  - templates service from @/services/templates
  - ExercisePickerModal from @/components/ExercisePickerModal
  - ExerciseEditorCard, EditingExercise, EditingSet from @/components/ExerciseEditorCard
  - Exercise type from @/types/database
  - TemplateExerciseInput, TemplateSetInput from @/types/services

  **Editing state type (defined at top of file):**
  ```typescript
  interface EditingTemplate {
    id: string | null;  // null = create mode
    name: string;
    exercises: EditingExercise[];
  }
  ```

  **Route params:**
  - `const { templateId } = useLocalSearchParams<{ templateId?: string }>()`
  - `const isEditing = !!templateId`

  **State:**
  - `editingTemplate: EditingTemplate` -- initialized as `{ id: null, name: '', exercises: [] }` for create mode
  - `isLoading: boolean` -- true while fetching template for edit mode
  - `isSaving: boolean` -- true during save operation
  - `error: string | null` -- validation or save error
  - `pickerVisible: boolean` -- ExercisePickerModal visibility
  - `hasChanges: boolean` -- tracks if user made any modifications (for unsaved changes dialog)
  - `initialTemplate: EditingTemplate | null` -- snapshot of loaded template for change detection

  **Edit mode loading:**
  On mount, if `templateId` exists:
  1. Set isLoading true
  2. Call `templates.getTemplate(templateId)`
  3. Convert to EditingTemplate format:
     ```typescript
     function templateToEditing(template: TemplateWithExercises): EditingTemplate {
       return {
         id: template.id,
         name: template.name,
         exercises: template.exercises.map(ex => ({
           exercise_id: ex.exercise_id,
           name: ex.name,
           category: ex.category,
           default_rest_seconds: ex.default_rest_seconds,
           sets: ex.sets.map(set => ({ ...set })),
         })),
       };
     }
     ```
  4. Set both `editingTemplate` and `initialTemplate` to the converted data
  5. Set isLoading false

  **Change tracking:**
  After any modification to editingTemplate, set `hasChanges = true`. A simple approach: set hasChanges to true on any name change, exercise add/remove/reorder, or set/rest modification.

  **Exercise picker integration:**
  - "Add Exercise" button opens ExercisePickerModal with `excludeIds` set to current exercise IDs (prevent duplicates)
  - On exercise select: create a new EditingExercise with 3 default sets (weight=0, reps=10), default_rest_seconds=90, and add to editingTemplate.exercises. Close picker.

  **Exercise management callbacks (passed to ExerciseEditorCard):**
  - `onUpdate(index, updatedExercise)`: replace exercise at index in exercises array
  - `onRemove(index)`: remove exercise at index
  - `onMoveUp(index)`: swap exercise at index with index-1 (if index > 0)
  - `onMoveDown(index)`: swap exercise at index with index+1 (if index < length-1)

  **Validation (on save):**
  1. Template name must not be empty after trim. If empty, set error: "Template name is required"
  2. At least one exercise required. If none, set error: "Add at least one exercise"
  3. Display error at top of form (below header, above name input)

  **Save flow:**
  1. Validate (abort if invalid)
  2. Set isSaving true
  3. Convert EditingTemplate to service format:
     ```typescript
     const exerciseInputs: TemplateExerciseInput[] = editingTemplate.exercises.map(ex => ({
       exercise_id: ex.exercise_id,
       default_rest_seconds: ex.default_rest_seconds,
       sets: ex.sets.map(set => ({
         set_number: set.set_number,
         weight: set.weight,
         reps: set.reps,
       })),
     }));
     ```
  4. If creating (id is null): call `templates.createTemplate(name.trim(), exerciseInputs)`
  5. If editing (id exists): call `templates.updateTemplate(id, name.trim(), exerciseInputs)`
  6. On success: `router.back()` (returns to dashboard, which will refresh via useTemplates)
  7. On error: set error message, set isSaving false

  **Cancel flow:**
  - If `hasChanges` is true: show `Alert.alert('Discard Changes?', 'You have unsaved changes...', [Keep Editing (cancel), Discard (destructive -> router.back())])`
  - If `hasChanges` is false: `router.back()` immediately

  **Screen layout (top to bottom):**

  1. SafeAreaView with bgPrimary background
  2. KeyboardAvoidingView with behavior="padding" on iOS
  3. **Header row:**
     - Cancel button (left) -- textSecondary, calls handleCancel
     - Title (center) -- "New Template" or "Edit Template" based on isEditing, semibold
     - Save button (right) -- accent color text, calls handleSave. Disabled (opacity 0.5) while isSaving.
     - All buttons: min 44px tap target
  4. **Error banner** (conditional): if error, show a View with danger background and error text
  5. **ScrollView** (flex: 1, vertical) containing:
     - Template name TextInput: bgElevated, placeholder "e.g., Upper Body Day", lg font
     - Exercise list: map over editingTemplate.exercises, render ExerciseEditorCard for each with index, totalExercises, and all callbacks
     - "Add Exercise" button: full width, accent border, accent text: "+ Add Exercise". Opens picker.
     - Bottom spacer for keyboard avoidance
  6. **ExercisePickerModal** rendered at the bottom (portal-like, uses RN Modal internally)

  **Loading state:**
  If isEditing and isLoading, show centered ActivityIndicator instead of the form.

  **Saving state:**
  While isSaving, Save button shows ActivityIndicator instead of text. All inputs remain visible but save button is disabled.

  **IMPORTANT: Do NOT use FlatList for the exercise list inside the ScrollView.** Use ScrollView with `.map()` to render exercise cards. Nesting FlatList inside ScrollView causes RN warnings and layout issues.

  **Modal swipe-dismiss prevention:**
  The template-editor route is already configured as `presentation: 'modal'` in _layout.tsx. To prevent accidental swipe-dismiss losing work, the cancel handler with unsaved changes check is sufficient since Expo Router fires `beforeRemove` on back gesture. Alternatively, disable the swipe gesture on the modal when there are unsaved changes by using the navigation event listener.

  Use `getStyles(theme)` pattern with `StyleSheet.create()`. Use `useTheme()` hook.
  </action>
  <verify>
  1. Run `npx tsc --noEmit` -- zero type errors
  2. Run the app on device and verify:
     - Tapping '+' on dashboard opens editor in create mode with "New Template" title
     - Can type a template name
     - Can add exercises via picker (picker opens, selection adds exercise card)
     - Exercise cards show set table with weight/reps inputs
     - Can add/remove sets
     - Can adjust rest timer
     - Can reorder exercises with up/down arrows
     - Can remove exercises
     - Save creates template and returns to dashboard
     - Template appears in dashboard grid after save
  </verify>
  <done>Template editor modal supports full create and edit flows: name input, exercise management via picker, set configuration, rest timer, reorder, validation, save with service calls, cancel with unsaved changes protection.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete template and dashboard system: dashboard with 2-column swipeable template grid, template editor modal with exercise configuration (sets, rest timer, reorder), create/edit/delete flows</what-built>
  <how-to-verify>
  Test on physical device via Expo Go:

  1. **Dashboard loads**: Open app, verify "IronLift" header with gear icon. Grid shows '+' card.
  2. **Empty state**: Verify message "No templates yet..." appears.
  3. **Create template**:
     a. Tap '+' card -- editor modal slides up with "New Template" title
     b. Type "Upper Body Day" in the name field
     c. Tap "Add Exercise" -- exercise picker opens
     d. Select an exercise -- picker closes, exercise card appears with 3 default sets
     e. Verify set table: set#, weight (0), reps (10), delete button
     f. Change weight to 135 on set 1
     g. Tap "Add Set" -- 4th set appears copying previous values
     h. Adjust rest timer with +10s/-10s buttons
     i. Add a second exercise
     j. Reorder exercises with up/down arrows
     k. Tap "Save" -- returns to dashboard, template card appears in grid
  4. **Template card**: Verify card shows name, exercise preview, and "Start" button
  5. **Swipe actions**: Swipe left on template card -- Edit and Delete buttons appear
  6. **Edit template**:
     a. Swipe left, tap Edit -- editor opens with "Edit Template" title and pre-filled data
     b. Change the name, tap Save -- returns to dashboard with updated name
  7. **Delete template**: Swipe left, tap Delete -- confirmation dialog appears. Confirm -- template removed from grid.
  8. **Validation**: Try saving with empty name or no exercises -- error message appears.
  9. **Unsaved changes**: Make changes, tap Cancel -- "Discard changes?" dialog appears.
  10. **Logout**: Tap gear icon -- verify logout still works.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Template editor supports create mode (new template) and edit mode (existing template)
3. Exercise picker adds exercises with 3 default sets each
4. Set table allows add/remove with minimum 1 set
5. Rest timer adjusts in 10-second increments with MM:SS display
6. Exercise reorder works with up/down arrows
7. Validation prevents empty name or zero exercises
8. Save calls createTemplate or updateTemplate and returns to dashboard
9. Unsaved changes dialog appears on cancel when changes exist
10. Dashboard refreshes and shows updated template list after save/delete
</verification>

<success_criteria>
- Full create flow: open editor, name template, add exercises, configure sets/rest, save, see card on dashboard
- Full edit flow: swipe card, tap edit, modify template, save, see updated card
- Full delete flow: swipe card, tap delete, confirm, card removed
- Validation blocks save without name or exercises
- Unsaved changes protected with confirmation dialog
- All UI matches dark theme with proper spacing and tap targets
</success_criteria>

<output>
After completion, create `.planning/phases/04-templates-and-dashboard/04-04-SUMMARY.md`
</output>
