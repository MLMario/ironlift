---
phase: 06-charts
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/hooks/useChartData.ts
  - src/components/KebabMenu.tsx
  - src/components/ChartCard.tsx
  - src/components/ChartSection.tsx
autonomous: true

must_haves:
  truths:
    - "Charts render as line charts with smooth curves, accent blue line, and gradient fill"
    - "Chart cards show exercise name and metric type in title"
    - "Kebab menu on chart card opens action menu with Delete option"
    - "Charts section shows header with 'Progress Charts' title"
    - "Empty state shows message when no charts configured"
    - "Tapping data points shows tooltip with exact value"
    - "Charts with <2 data points show 'Not enough data' message"
  artifacts:
    - path: "src/hooks/useChartData.ts"
      provides: "Hook that computes chart data from cached workout history per chart config"
      exports: ["useChartData"]
    - path: "src/components/KebabMenu.tsx"
      provides: "Three-dot horizontal menu with dropdown for chart actions"
      exports: ["KebabMenu"]
    - path: "src/components/ChartCard.tsx"
      provides: "Single chart card with title, kebab menu, and LineChart rendering"
      exports: ["ChartCard"]
    - path: "src/components/ChartSection.tsx"
      provides: "Charts section with header, chart list, and empty state"
      exports: ["ChartSection"]
  key_links:
    - from: "src/hooks/useChartData.ts"
      to: "src/services/logging.ts"
      via: "getExerciseMetrics call"
      pattern: "logging\\.getExerciseMetrics"
    - from: "src/components/ChartCard.tsx"
      to: "react-native-gifted-charts"
      via: "LineChart import"
      pattern: "import.*LineChart.*from.*react-native-gifted-charts"
    - from: "src/components/ChartSection.tsx"
      to: "src/components/ChartCard.tsx"
      via: "ChartCard render"
      pattern: "<ChartCard"
---

<objective>
Build the chart rendering pipeline: a hook to compute chart data from workout history, the KebabMenu component, the ChartCard component wrapping react-native-gifted-charts LineChart, and the ChartSection component that displays all charts with header and empty state.

Purpose: These components are the visual core of the charts feature. ChartCard renders the actual line charts, and ChartSection organizes them into a dashboard-ready section.
Output: Four new files providing the complete chart display stack.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-charts/06-CONTEXT.md
@.planning/phases/06-charts/06-RESEARCH.md
@.planning/phases/06-charts/06-01-SUMMARY.md

@src/services/logging.ts (getExerciseMetrics returns { labels: string[], values: number[] })
@src/types/services.ts (UserChartData, ChartData types)
@src/components/TemplateGrid.tsx (section header pattern to match)
@src/components/ConfirmationModal.tsx (delete confirmation modal pattern)
@src/theme/tokens.ts (theme token names)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useChartData hook and KebabMenu component</name>
  <files>src/hooks/useChartData.ts, src/components/KebabMenu.tsx</files>
  <action>
**Create `src/hooks/useChartData.ts`:**

A hook that computes chart data for a single chart config using the existing `logging.getExerciseMetrics()` function.

```typescript
interface ChartLineDataItem {
  value: number;
  label: string;
}

interface UseChartDataResult {
  data: ChartLineDataItem[];
  isLoading: boolean;
}
```

Implementation:
1. Accept `chart: UserChartData` as parameter
2. State: `data: ChartLineDataItem[]` (default []), `isLoading: boolean` (default true)
3. useEffect that calls `logging.getExerciseMetrics()` with:
   - `chart.exercise_id`
   - `{ metric: chart.metric_type, mode: chart.x_axis_mode, limit: chart.x_axis_mode === 'session' ? 52 : 365 }`
4. Transform the result `{ labels, values }` to `ChartLineDataItem[]`:
   - For date mode: format label from "2026-01-15" to "1/15" using `formatDateLabel()`
   - For session mode: use just the number string (e.g., "1", "2", "3") -- strip the "Session " prefix from the labels that getExerciseMetrics returns
5. Set data and isLoading=false
6. Dependency array: `[chart.id]` (recompute only if the chart config itself changes)
7. Include a `formatDateLabel(dateStr: string): string` helper: parse date, return `${month}/${day}`

Export `useChartData` and the `ChartLineDataItem` type.

**Create `src/components/KebabMenu.tsx`:**

A reusable three-dot horizontal menu with a dropdown. Uses RN Modal with transparent background and fade animation.

Props:
```typescript
interface KebabMenuProps {
  onDelete: () => void;
}
```

Implementation:
1. State: `menuVisible: boolean`
2. Render a Pressable with Ionicons `ellipsis-horizontal` icon (size 20, color textMuted), hitSlop 8 for 44px tap target
3. On press: set menuVisible=true
4. Modal (transparent, animationType="fade"):
   - Full-screen Pressable overlay (transparent background) that closes menu on press
   - Dropdown View positioned at top-right area (absolute positioning):
     - Background: bgSurface, borderRadius: md, padding: sm
     - Shadow/elevation for depth
     - Single "Delete" Pressable item:
       - Text "Delete" in danger color
       - On press: close menu, call onDelete
       - Min height 44px for tap target
5. Use `useRef` + `onLayout` to measure the kebab button position for dropdown placement, OR simply position the dropdown with `position: 'absolute'` relative to the card (simpler approach -- the dropdown can be positioned near the top-right of the card since the kebab is always there)

NOTE: Use a simpler approach -- render the dropdown inside the component using absolute positioning rather than Modal. The Modal approach causes z-index issues within ScrollView. Instead:
- When menuVisible, render an overlay Pressable (fullscreen, transparent) using the Portal pattern OR just use Modal (the ConfirmationModal already uses Modal successfully in the app)
- Use Modal with transparent background -- this is the proven pattern in this codebase

Style with getStyles(theme) pattern. Import `Ionicons` from `@expo/vector-icons`.
  </action>
  <verify>Run `npx tsc --noEmit` to verify no TypeScript errors in both files.</verify>
  <done>useChartData hook computes chart data from workout history. KebabMenu renders a three-dot button that opens a dropdown with Delete option.</done>
</task>

<task type="auto">
  <name>Task 2: Create ChartCard and ChartSection components</name>
  <files>src/components/ChartCard.tsx, src/components/ChartSection.tsx</files>
  <action>
**Create `src/components/ChartCard.tsx`:**

A single chart card displaying title, kebab menu, and LineChart.

Props:
```typescript
interface ChartCardProps {
  chart: UserChartData;
  onDelete: (chartId: string) => void;
}
```

Implementation:
1. Use `useChartData(chart)` hook to get `{ data, isLoading }`
2. Compute title: `${chart.exercises.name} \u2014 ${charts.getMetricDisplayName(chart.metric_type)}` (em dash per locked decision, use the display helper from charts service). Shorten "Max Volume Set (lbs)" to "Max Volume" in the getMetricDisplayName (already done in Plan 01)
3. Card container: bgSurface, borderRadius lg, overflow hidden
4. Header row: title (flex 1, numberOfLines 1, ellipsizeMode tail) + KebabMenu (onDelete calls a handler that shows ConfirmationModal)
5. **Delete flow:** When KebabMenu triggers onDelete, show ConfirmationModal with title "Delete Chart", message `Delete "${chart.exercises.name}" chart?`, confirmLabel "Delete", confirmVariant "danger". On confirm, call props.onDelete(chart.id).
6. Chart area:
   - If isLoading: show a dim placeholder area (bgElevated, height 180) -- no spinner per discretion recommendation
   - If data.length < 2: show "Not enough data to display chart" message (textMuted, centered in 180px area)
   - If data.length >= 2: render `<LineChart>` with these exact props (per locked decisions and research):
     ```
     data={data}
     areaChart
     curved
     curvature={0.4}
     color="#4f9eff"
     startFillColor="rgba(79, 158, 255, 0.3)"
     endFillColor="rgba(79, 158, 255, 0.01)"
     startOpacity={0.3}
     endOpacity={0.01}
     dataPointsColor="#4f9eff"
     dataPointsRadius={4}
     height={180}
     spacing={40}
     initialSpacing={20}
     endSpacing={20}
     hideYAxisText
     xAxisLabelTextStyle={{ color: theme.colors.textMuted, fontSize: 10 }}
     xAxisColor={theme.colors.border}
     yAxisColor="transparent"
     hideRules
     isAnimated={false}
     nestedScrollEnabled
     scrollToEnd
     pointerConfig={{
       pointerColor: '#4f9eff',
       radius: 6,
       activatePointersOnLongPress: false,
       persistPointer: true,
       showPointerStrip: true,
       pointerStripColor: theme.colors.border,
       pointerLabelComponent: (items) => tooltip view showing value with unit suffix
     }}
     ```
7. Tooltip (pointerLabelComponent): Dark background (rgba(0,0,0,0.8)), white text, positioned above pointer. Show value with unit: "225 lbs" for max_volume_set, "12 sets" for total_sets. Rounded to nearest integer.
8. Import `LineChart` from `react-native-gifted-charts`
9. Import ConfirmationModal from `@/components/ConfirmationModal`
10. State for `showDeleteConfirm: boolean`

Use getStyles(theme) pattern.

**Create `src/components/ChartSection.tsx`:**

The charts section that renders on the dashboard below templates.

Props:
```typescript
interface ChartSectionProps {
  charts: UserChartData[];
  isLoading: boolean;
  onDelete: (chartId: string) => void;
  onAddChart: () => void;
  canAddChart: boolean; // false when 25 chart limit reached
}
```

Implementation:
1. Section header matching TemplateGrid pattern:
   - "Progress Charts" title (same style as "My Templates": 2xl, semibold, textPrimary)
   - If canAddChart: "+ Add Chart" button (same style as "+ Create" button: accent bg, md radius, md/sm padding)
   - If NOT canAddChart: show "Maximum charts reached" text in textMuted instead of button
2. Chart list: Render each chart with `<ChartCard>` using `.map()` (NOT FlatList -- these render inside a parent ScrollView)
   - Gap between cards: theme.spacing.sm
   - Horizontal padding: theme.spacing.md
3. Empty state (when charts.length === 0 and !isLoading):
   - "No charts configured yet. Add a chart to track your progress on an exercise." (per locked decision)
   - textSecondary color, centered, padding md
4. Loading state (when isLoading and charts.length === 0):
   - ActivityIndicator centered, accent color
5. Always render the section header even when empty (per locked decision: always visible)

Use getStyles(theme) pattern.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. Check that:
- ChartCard renders LineChart from react-native-gifted-charts
- ChartCard has delete confirmation flow using ConfirmationModal
- ChartSection renders all charts with .map() (not FlatList)
- ChartSection has correct empty state text
  </verify>
  <done>ChartCard renders line charts with gradient fill, tooltips, and delete confirmation. ChartSection organizes charts with header, empty state, and 25-chart limit enforcement.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. ChartCard imports LineChart from react-native-gifted-charts and renders with all locked decision props (areaChart, curved, isAnimated={false}, hideYAxisText, pointerConfig)
3. KebabMenu opens a dropdown with "Delete" option
4. ChartSection header matches TemplateGrid section header pattern
5. Empty state text matches locked decision: "No charts configured yet. Add a chart to track your progress on an exercise."
6. Charts rendered with .map() not FlatList (avoiding nested FlatList issue)
</verification>

<success_criteria>
- useChartData hook transforms getExerciseMetrics output to LineChart-compatible data items
- KebabMenu provides three-dot dropdown menu with Delete action
- ChartCard renders LineChart with smooth curves, #4f9eff accent line, gradient fill, tooltips, no animation
- ChartCard handles <2 data points with "Not enough data" message
- ChartCard has delete confirmation via ConfirmationModal
- ChartSection displays section header + chart cards + empty state
- ChartSection enforces 25 chart limit (hides Add button)
- All files compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-charts/06-02-SUMMARY.md`
</output>
