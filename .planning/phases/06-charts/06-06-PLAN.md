---
phase: 06-charts
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/KebabMenu.tsx
  - src/components/ChartCard.tsx
  - src/components/AddChartSheet.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "KebabMenu dismisses cleanly without delete button flashing at dashboard top"
    - "Chart tooltip displays value text readable in a single line"
    - "Add Chart sheet shows CTA buttons fully visible and tappable"
  artifacts:
    - path: "src/components/KebabMenu.tsx"
      provides: "Clean dismiss without position flash"
      contains: "setMenuVisible(false)"
    - path: "src/components/ChartCard.tsx"
      provides: "Wide enough tooltip container"
      contains: "pointerLabelWidth"
    - path: "src/components/AddChartSheet.tsx"
      provides: "Scrollable form with pinned buttons"
      contains: "ScrollView"
  key_links:
    - from: "src/components/KebabMenu.tsx"
      to: "Modal animationType=fade"
      via: "triggerPos preserved during fade-out so dropdown stays in place"
      pattern: "setMenuVisible\\(false\\)"
    - from: "src/components/ChartCard.tsx"
      to: "react-native-gifted-charts StripAndLabel wrapper"
      via: "pointerLabelWidth overrides library default 20px"
      pattern: "pointerLabelWidth"
---

<objective>
Close remaining 3 UAT gaps from Phase 06 Charts round 2 testing. The round 1 gap closure (06-05) partially fixed these issues but the root causes were deeper than originally diagnosed.

Purpose: Fix kebab menu dismiss flash, chart tooltip text wrapping (wrong layer targeted), and Add Chart CTA cutoff (content overflows sheet height) -- all with properly diagnosed root causes from round 2 debug sessions.

Output: All 3 round 2 UAT issues resolved. Charts phase fully passing.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-charts/06-UAT-round2.md
@.planning/debug/kebab-menu-dismiss-flash.md
@.planning/debug/chart-tooltip-text-width-round2.md
@.planning/debug/add-chart-sheet-cta-cutoff-round2.md
@.planning/phases/06-charts/06-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix KebabMenu dismiss flash and chart tooltip width</name>
  <files>
    src/components/KebabMenu.tsx
    src/components/ChartCard.tsx
  </files>
  <action>
    Two targeted fixes across two files. Both are single-line changes.

    **1. KebabMenu.tsx -- Fix dismiss flash (Gap 1, minor)**

    Root cause: `handleClose()` (line 36-39) calls `setTriggerPos(null)` simultaneously with `setMenuVisible(false)`. React batches both state updates into one re-render. The Modal's `animationType="fade"` plays a ~300ms fade-out during which the dropdown is still rendered. With `triggerPos=null`, the position expression `triggerPos ? triggerPos.y + triggerPos.height : 80` falls through to the fallback value `80`, causing the dropdown to jump to the top of the screen during the fade-out.

    Fix: Remove `setTriggerPos(null)` from `handleClose`. The position value is inert when the Modal is hidden and gets freshly measured via `handleOpenMenu` on the next open. There is no reason to eagerly reset it.

    Current handleClose (lines 36-39):
    ```typescript
    const handleClose = () => {
      setMenuVisible(false);
      setTriggerPos(null);
    };
    ```

    Change to:
    ```typescript
    const handleClose = () => {
      setMenuVisible(false);
    };
    ```

    That is the entire fix. Do NOT change anything else in KebabMenu.tsx.

    **2. ChartCard.tsx -- Fix tooltip text wrapping (Gap 2, major)**

    Root cause: The 06-05 fix added `flexShrink: 0` to the inner tooltip View style. This is ineffective because the constraint comes from the PARENT View created by react-native-gifted-charts. The library wraps `pointerLabelComponent` output in a View with an explicit `width: pointerLabelWidth` property. The default `pointerLabelWidth` is 20px (from `gifted-charts-core/dist/utils/constants.js` line 271). An inner `flexShrink: 0` cannot override an explicit width on its parent.

    Fix: Add `pointerLabelWidth: 120` and `autoAdjustPointerLabelPosition: true` to the `pointerConfig` object in the `renderChartArea` function. This overrides the library's 20px default, giving the tooltip enough width for values like "225 lbs" or "12 sets".

    In the `pointerConfig` object (around lines 114-132), add these two properties after the existing `activatePointersOnLongPress: true` line:

    ```typescript
    pointerConfig={{
      pointerColor: "#4f9eff",
      radius: 3,
      activatePointersOnLongPress: true,
      showPointerStrip: true,
      pointerStripColor: theme.colors.border,
      pointerLabelWidth: 120,
      autoAdjustPointerLabelPosition: true,
      pointerLabelComponent: (items: ChartLineDataItem[]) => {
        // ... existing tooltip render code unchanged ...
      },
    }}
    ```

    The `flexShrink: 0` on the tooltip style (line ~209) can remain -- it is harmless now that the parent width is correct.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors.
    Confirm in KebabMenu.tsx: handleClose only calls setMenuVisible(false), NOT setTriggerPos(null).
    Confirm in ChartCard.tsx: pointerConfig contains pointerLabelWidth: 120 and autoAdjustPointerLabelPosition: true.
  </verify>
  <done>
    - Kebab menu dropdown stays in its measured position during the Modal fade-out animation (no flash to top)
    - Chart tooltip parent container is 120px wide, text displays on a single line
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix AddChartSheet CTA cutoff with scrollable form</name>
  <files>
    src/components/AddChartSheet.tsx
  </files>
  <action>
    Root cause: The sheet's fixed 50% height provides ~344pt of interior space (after padding), but form content totals ~436pt (title + exercise selector + 2 radio groups with 4 options at 44pt min-height + 4 gaps at 16pt + button row at 44pt). The button row overflows and is clipped. The round 1 safe area fix actually made it worse by reducing available interior space by ~34pt.

    Fix: Wrap the form content (everything except the button row) in a ScrollView, and keep the button row pinned at the bottom outside the scroll area. This handles any content height regardless of device size, matching the pattern already used by the exercise select view in this same component.

    **Step-by-step changes in AddChartSheet.tsx:**

    1. The `ScrollView` import already exists (line 20). No new imports needed.

    2. In the form view JSX (the `step === 'form'` branch, starting around line 280), restructure the formContainer children. Currently all children are direct children of `<View style={styles.formContainer}>`. Change to:

    ```tsx
    <View style={styles.formContainer}>
      <ScrollView
        style={styles.formScroll}
        contentContainerStyle={styles.formScrollContent}
        keyboardShouldPersistTaps="handled"
        bounces={false}
        showsVerticalScrollIndicator={false}
      >
        {/* Title */}
        <Text style={styles.title}>Add Chart</Text>

        {/* Exercise Selector */}
        <View style={styles.fieldGroup}>
          <Text style={styles.fieldLabel}>Exercise</Text>
          <Pressable
            style={({ pressed }) => [
              styles.exerciseSelector,
              pressed && styles.exerciseSelectorPressed,
            ]}
            onPress={() => setStep('selectExercise')}
          >
            <Text
              style={
                selectedExercise
                  ? styles.exerciseSelectorText
                  : styles.exerciseSelectorPlaceholder
              }
              numberOfLines={1}
            >
              {selectedExercise
                ? selectedExercise.name
                : 'Select Exercise'}
            </Text>
          </Pressable>
        </View>

        {/* Metric Type Radio */}
        <RadioGroup
          label="Metric"
          options={METRIC_OPTIONS}
          selected={metricType}
          onSelect={setMetricType}
          theme={theme}
        />

        {/* X-Axis Mode Radio */}
        <RadioGroup
          label="X-Axis"
          options={AXIS_OPTIONS}
          selected={xAxisMode}
          onSelect={setXAxisMode}
          theme={theme}
        />

        {/* Error */}
        {error ? <Text style={styles.errorText}>{error}</Text> : null}
      </ScrollView>

      {/* Button Row -- pinned outside ScrollView */}
      <View style={styles.buttonRow}>
        <Pressable
          style={({ pressed }) => [
            styles.button,
            styles.cancelButton,
            pressed && styles.cancelButtonPressed,
          ]}
          onPress={onClose}
        >
          <Text style={styles.cancelButtonText}>Cancel</Text>
        </Pressable>

        <Pressable
          style={({ pressed }) => [
            styles.button,
            styles.submitButton,
            pressed && !(!selectedExercise || isSubmitting) && styles.submitButtonPressed,
            (!selectedExercise || isSubmitting) &&
              styles.submitButtonDisabled,
          ]}
          onPress={handleAddChart}
          disabled={!selectedExercise || isSubmitting}
        >
          {isSubmitting ? (
            <ActivityIndicator
              size="small"
              color={theme.colors.textPrimary}
            />
          ) : (
            <Text style={styles.submitButtonText}>Add Chart</Text>
          )}
        </Pressable>
      </View>
    </View>
    ```

    3. Update the styles. Remove `marginTop: 'auto'` from `buttonRow` (no longer needed since the button row is pinned outside the ScrollView). Add two new styles:

    Add to the StyleSheet.create in getStyles:
    ```typescript
    formScroll: {
      flex: 1,
    },
    formScrollContent: {
      gap: theme.spacing.md,
    },
    ```

    Update existing buttonRow style -- remove `marginTop: 'auto'` and add `paddingTop`:
    ```typescript
    buttonRow: {
      flexDirection: 'row',
      gap: theme.spacing.sm,
      paddingTop: theme.spacing.md,
    },
    ```

    The `formContainer` style keeps `flex: 1` but remove the `gap` property from it (gap is now on the ScrollView's contentContainerStyle):
    ```typescript
    formContainer: {
      flex: 1,
    },
    ```

    These changes ensure:
    - Form fields scroll if they exceed available space (works on all device sizes including iPhone SE)
    - Button row is always visible and pinned at the bottom
    - The layout matches the existing exercise select view pattern (ScrollView + fixed header)
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors.
    Confirm in AddChartSheet.tsx:
    - Form fields are wrapped in a ScrollView with flex: 1
    - Button row is outside the ScrollView, directly in formContainer
    - formContainer no longer has gap style
    - buttonRow no longer has marginTop: 'auto', has paddingTop instead
  </verify>
  <done>
    - Add Chart CTA buttons ("Add Chart" and "Cancel") are fully visible and tappable on all device sizes
    - Form content scrolls if it exceeds available space (handles iPhone SE and landscape)
    - Button row is pinned at the bottom of the sheet, never clipped
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `npx tsc --noEmit` passes with no errors
2. Code review confirms:
   - KebabMenu.tsx: handleClose does NOT call setTriggerPos(null)
   - ChartCard.tsx: pointerConfig has `pointerLabelWidth: 120` and `autoAdjustPointerLabelPosition: true`
   - AddChartSheet.tsx: form fields in ScrollView, button row pinned outside ScrollView
</verification>

<success_criteria>
All 3 round 2 UAT gaps addressed:
1. Kebab menu dismiss: dropdown stays in position during fade-out (triggerPos preserved)
2. Chart tooltip: text displays on single line (pointerLabelWidth overrides 20px default)
3. Add Chart CTA: buttons fully visible on all devices (scrollable form, pinned buttons)
</success_criteria>

<output>
After completion, create `.planning/phases/06-charts/06-06-SUMMARY.md`
</output>
