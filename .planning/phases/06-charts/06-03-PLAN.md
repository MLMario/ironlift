---
phase: 06-charts
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/AddChartSheet.tsx
autonomous: true

must_haves:
  truths:
    - "User can open a half-height bottom sheet to create a new chart"
    - "Exercise list shows only exercises with logged workout data, grouped by category"
    - "User selects metric type via radio buttons (Total Sets / Max Volume)"
    - "User selects x-axis mode via radio buttons (By Date / By Session)"
    - "Submit button labeled 'Add Chart' creates the chart"
    - "If no exercises have logged data, show 'No exercise data yet' with Cancel only"
  artifacts:
    - path: "src/components/AddChartSheet.tsx"
      provides: "Half-height bottom sheet for chart creation with exercise selection sub-view"
      exports: ["AddChartSheet"]
  key_links:
    - from: "src/components/AddChartSheet.tsx"
      to: "src/services/exercises.ts"
      via: "getExercisesWithLoggedData call"
      pattern: "exercises\\.getExercisesWithLoggedData"
    - from: "src/components/AddChartSheet.tsx"
      to: "src/services/charts.ts"
      via: "createChart call"
      pattern: "charts\\.createChart"
---

<objective>
Build the Add Chart bottom sheet -- a half-height modal with step-by-step exercise selection, metric type radio buttons, x-axis mode radio buttons, and an "Add Chart" submit button.

Purpose: This is the creation flow for charts. Users select an exercise (from those with workout data), choose a metric, choose an axis mode, and submit. The multi-step flow (form -> exercise picker sub-view -> back to form) needs careful state management.
Output: One component file providing the complete chart creation flow.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-charts/06-CONTEXT.md
@.planning/phases/06-charts/06-RESEARCH.md
@.planning/phases/06-charts/06-01-SUMMARY.md

@src/services/exercises.ts (getExercisesWithLoggedData -- already exists, returns Exercise[] sorted by category then name)
@src/services/charts.ts (createChart -- from Plan 01)
@src/types/services.ts (CreateChartInput, Exercise types)
@src/types/database.ts (Exercise type with category field)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddChartSheet component</name>
  <files>src/components/AddChartSheet.tsx</files>
  <action>
Create `src/components/AddChartSheet.tsx` -- a half-height bottom sheet for creating charts.

Props:
```typescript
interface AddChartSheetProps {
  visible: boolean;
  onClose: () => void;
  onChartCreated: () => void; // callback to refresh chart list after creation
}
```

**Implementation uses RN Modal with slide animation (hand-rolled, NOT @gorhom/bottom-sheet per research recommendation).**

**State machine for multi-step flow:**
- `step: 'form' | 'selectExercise'`
- `selectedExercise: Exercise | null`
- `metricType: 'total_sets' | 'max_volume_set'` (default: 'total_sets')
- `xAxisMode: 'date' | 'session'` (default: 'session')
- `exercisesWithData: Exercise[]` (loaded on mount)
- `isLoadingExercises: boolean`
- `isSubmitting: boolean`
- `error: string | null`

**Reset state on every open** via useEffect on `visible` prop (same pattern as ExercisePickerModal per decision [03-03]):
```typescript
useEffect(() => {
  if (visible) {
    setStep('form');
    setSelectedExercise(null);
    setMetricType('total_sets');
    setXAxisMode('session');
    setError(null);
    loadExercises();
  }
}, [visible]);
```

**loadExercises function:**
1. Set isLoadingExercises=true
2. Call `exercises.getExercisesWithLoggedData()` (already exists, returns Exercise[] sorted by category then name)
3. Set exercisesWithData with result
4. Set isLoadingExercises=false

**Modal structure:**
```
<Modal visible={visible} transparent animationType="slide" onRequestClose={onClose}>
  <Pressable style={overlay} onPress={onClose}>
    <Pressable style={sheet} onPress={() => {}}>
      {/* Prevent overlay dismiss when tapping sheet content */}
      {step === 'form' ? <FormView /> : <ExerciseSelectView />}
    </Pressable>
  </Pressable>
</Modal>
```

**Sheet styling:**
- Position at bottom of screen: `position: 'absolute', bottom: 0, left: 0, right: 0`
- Height: approximately 50% of screen (use `Dimensions.get('window').height * 0.5` or a fixed `maxHeight: 400`)
- Background: bgSurface
- Top corners rounded: borderTopLeftRadius and borderTopRightRadius with radii.lg
- Padding: spacing.lg
- Overlay: rgba(0,0,0,0.6) (matching ConfirmationModal pattern)

**Form view (step === 'form'):**
1. Title: "Add Chart" (lg, semibold, textPrimary)
2. Exercise selector:
   - Label: "Exercise" (sm, textSecondary)
   - Pressable showing selected exercise name or "Select Exercise" placeholder (textMuted)
   - Styled as a field: bgElevated background, borderRadius md, padding sm, border with border color
   - On press: setStep('selectExercise')
3. Metric type radio group:
   - Label: "Metric" (sm, textSecondary)
   - Two options: "Total Sets" (value: 'total_sets'), "Max Volume" (value: 'max_volume_set')
   - Hand-rolled radio buttons per constitution (no component libraries):
     - Each: Row with 20px circle (2px border, accent when selected, textMuted when not) + label text
     - Selected: inner 10px filled circle in accent color
     - Min height 44px per tap target requirement
4. X-axis mode radio group:
   - Label: "X-Axis" (sm, textSecondary)
   - Two options: "By Date" (value: 'date'), "By Session" (value: 'session')
   - Same radio button pattern as metric type
5. Error message (if error): danger color text
6. Button row:
   - "Cancel" button: bgElevated background, textSecondary text, onPress calls onClose
   - "Add Chart" button: accent background, textPrimary text, disabled when no exercise selected or isSubmitting
   - Both buttons: minHeight 44px, flex 1, borderRadius md

**Submit handler (handleAddChart):**
1. Guard: if no selectedExercise, return
2. Set isSubmitting=true, error=null
3. Call `charts.createChart({ exercise_id: selectedExercise.id, metric_type: metricType, x_axis_mode: xAxisMode })`
4. If success: call onChartCreated(), call onClose()
5. If error: set error message. If network error, show "Internet connection required to create charts." per research recommendation
6. Set isSubmitting=false

**Exercise select view (step === 'selectExercise'):**
1. Header: "Select Exercise" title + "Back" button (returns to form view: setStep('form'))
2. If isLoadingExercises: ActivityIndicator
3. If exercisesWithData.length === 0: "No exercise data yet" message (per locked decision) with only a Cancel-equivalent (the Back button serves this purpose)
4. Exercise list: ScrollView with exercises grouped by category
   - Group by category using a reduce/Map
   - For each category: category header text (sm, semibold, textMuted, uppercase)
   - For each exercise in category: Pressable row with exercise name
     - On press: setSelectedExercise(exercise), setStep('form')
     - Min height 44px, padding sm
     - Highlight with bgElevated on press

Use getStyles(theme) pattern. Import exercises service from `@/services/exercises`, charts service from `@/services/charts`.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. Check that:
- AddChartSheet uses Modal with animationType="slide"
- Exercise selection is a sub-view (step state machine), not a nested modal
- Radio buttons are hand-rolled (no component library imports)
- State resets on every open
  </verify>
  <done>AddChartSheet renders a half-height bottom sheet with exercise selection sub-view, metric/axis radio buttons, and Add Chart submit button. State resets on open. Handles empty exercise data state.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. AddChartSheet uses `animationType="slide"` and `transparent` on Modal
3. Exercise list comes from `exercises.getExercisesWithLoggedData()` (already exists)
4. Only exercises with logged workout data are shown
5. Empty exercise state shows "No exercise data yet" per locked decision
6. Radio buttons use hand-rolled circle pattern (no imports from component libraries)
7. Submit calls `charts.createChart()` and triggers onChartCreated callback
8. State resets when visible changes to true
</verification>

<success_criteria>
- AddChartSheet presents as half-height bottom sheet (slide up from bottom)
- Step-by-step flow: form -> select exercise (sub-view) -> back to form
- Exercise list grouped by category, only exercises with logged data
- Radio buttons for metric type (Total Sets / Max Volume) and x-axis (By Date / By Session)
- "Add Chart" submit creates chart via service and triggers refresh callback
- "No exercise data yet" shown when no exercises have workout history
- Error handling for offline chart creation
- All 44px tap targets met
</success_criteria>

<output>
After completion, create `.planning/phases/06-charts/06-03-SUMMARY.md`
</output>
