---
phase: 06-charts
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useChartData.ts
  - src/components/ChartCard.tsx
  - src/components/AddChartSheet.tsx
  - src/components/KebabMenu.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Add Chart bottom sheet shows full content including CTA button above home indicator"
    - "Chart tooltip displays value text readable on a single line"
    - "Kebab menu dropdown appears next to the three-dot icon, not at top of screen"
    - "Chart data refreshes automatically after finishing a workout"
    - "Exercise picker list responds to first touch/drag immediately"
    - "Charts with many data points are horizontally scrollable"
  artifacts:
    - path: "src/hooks/useChartData.ts"
      provides: "Chart data refetch on focus"
      contains: "chart]"
    - path: "src/components/ChartCard.tsx"
      provides: "Tooltip width fix and scroll enablement"
      contains: "activatePointersOnLongPress: true"
    - path: "src/components/AddChartSheet.tsx"
      provides: "Safe area CTA and first-touch fix"
      contains: "useSafeAreaInsets"
    - path: "src/components/KebabMenu.tsx"
      provides: "Measured dropdown positioning"
      contains: "measure"
  key_links:
    - from: "src/hooks/useChartData.ts"
      to: "app/index.tsx"
      via: "refreshCharts triggers new chart object references, useEffect dep [chart] catches them"
      pattern: "\\[chart\\]"
    - from: "src/components/KebabMenu.tsx"
      to: "src/components/ChartCard.tsx"
      via: "KebabMenu measures trigger position and renders dropdown at measured coordinates"
      pattern: "measure"
---

<objective>
Close all 6 UAT gaps from Phase 06 Charts testing. These are UI and data refresh bugs found during user acceptance testing.

Purpose: Fix CTA cutoff, tooltip text wrapping, kebab menu positioning, chart data refresh after workout, exercise picker first-touch swallowed, and chart horizontal scroll -- all diagnosed with root causes and specific fixes identified.

Output: All 6 UAT issues resolved. Charts phase fully passing.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-charts/06-UAT.md
@.planning/debug/add-chart-sheet-cta-cutoff.md
@.planning/debug/chart-tooltip-text-width.md
@.planning/debug/kebab-menu-positioning.md
@.planning/debug/chart-no-refresh-after-workout.md
@.planning/debug/exercise-picker-first-touch.md
@.planning/debug/chart-horizontal-scroll.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix chart data refresh, tooltip width, and horizontal scroll</name>
  <files>
    src/hooks/useChartData.ts
    src/components/ChartCard.tsx
  </files>
  <action>
    Three one-line fixes across two files:

    **1. useChartData.ts -- Fix chart data not refreshing after workout (Gap 4)**
    Line 97: Change useEffect dependency array from `[chart.id]` to `[chart]`.

    When dashboard regains focus after a workout, `refreshCharts()` fetches new chart config objects from Supabase. These are new object references (different by `Object.is()`), but `chart.id` is the same string. Changing the dependency to the whole `chart` object means the useEffect re-fires when `refreshCharts()` returns new references, triggering a data refetch that picks up the new workout data.

    Current line 97:
    ```
    }, [chart.id]);
    ```
    Change to:
    ```
    }, [chart]);
    ```

    **2. ChartCard.tsx -- Fix tooltip text wrapping (Gap 2)**
    In the `getStyles` function, add `flexShrink: 0` to the `tooltip` style object (around line 208-213). The tooltip View container lacks width constraints, so when react-native-gifted-charts' pointer component positions it, the View collapses to minimum width, wrapping text at character boundaries.

    Current tooltip style:
    ```
    tooltip: {
      backgroundColor: "rgba(0,0,0,0.8)",
      borderRadius: theme.radii.sm,
      paddingHorizontal: theme.spacing.sm,
      paddingVertical: theme.spacing.xs,
    },
    ```
    Add `flexShrink: 0` to prevent container collapse:
    ```
    tooltip: {
      backgroundColor: "rgba(0,0,0,0.8)",
      borderRadius: theme.radii.sm,
      paddingHorizontal: theme.spacing.sm,
      paddingVertical: theme.spacing.xs,
      flexShrink: 0,
    },
    ```

    **3. ChartCard.tsx -- Fix horizontal scroll disabled (Gap 6)**
    In the `pointerConfig` object inside `renderChartArea` (around line 120), change `activatePointersOnLongPress` from `false` to `true`.

    Per react-native-gifted-charts documentation: when `pointerConfig` is present, scroll is automatically disabled unless `activatePointersOnLongPress` is `true`. With `true`, horizontal scroll works by default and tooltip activates on long press instead of tap.

    Current:
    ```
    activatePointersOnLongPress: false,
    ```
    Change to:
    ```
    activatePointersOnLongPress: true,
    ```

    Also remove `persistPointer: true` since it conflicts with long-press mode (pointer should disappear when user lifts finger to resume scrolling).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors.
    Visually confirm in the code: useChartData.ts dependency is `[chart]`, ChartCard tooltip has `flexShrink: 0`, and `activatePointersOnLongPress` is `true`.
  </verify>
  <done>
    - useChartData re-fetches when chart object reference changes (new data after workout)
    - Tooltip container does not collapse to zero width
    - Chart horizontal scroll is enabled by default, tooltip activates on long press
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix AddChartSheet CTA cutoff and first-touch swallowed</name>
  <files>
    src/components/AddChartSheet.tsx
  </files>
  <action>
    Two fixes in AddChartSheet.tsx:

    **1. Fix CTA button cut off by safe area (Gap 1)**
    The sheet uses a fixed 50% height without accounting for the device's bottom safe area inset (home indicator on iPhone X+). The buttonRow with `marginTop: 'auto'` pushes into the unsafe zone.

    Fix: Use `useSafeAreaInsets` from `react-native-safe-area-context` to add bottom padding to the sheet container.

    Add import at the top:
    ```tsx
    import { useSafeAreaInsets } from 'react-native-safe-area-context';
    ```

    Inside the component function, add:
    ```tsx
    const insets = useSafeAreaInsets();
    ```

    On the sheet Pressable (currently line 270), apply dynamic paddingBottom that accounts for the safe area inset:
    ```tsx
    <View
      style={[styles.sheet, { paddingBottom: theme.spacing.lg + insets.bottom }]}
      onStartShouldSetResponder={() => true}
    >
    ```

    Note: This replaces the inner Pressable with a View (see fix 2 below). The `onStartShouldSetResponder={() => true}` prevents touch events from propagating to the overlay behind.

    **2. Fix first touch swallowed in exercise picker (Gap 5)**
    The sheet content is wrapped in a `<Pressable onPress={() => {}}>` (line 270) to prevent overlay dismissal when tapping inside the sheet. This creates a touch responder hierarchy issue: when the step changes from 'form' to 'selectExercise', the first touch after the content swap is consumed by the parent Pressable re-establishing responder ownership.

    Fix: Replace the inner `<Pressable style={styles.sheet} onPress={() => {}}>` with a `<View>` that uses `onStartShouldSetResponder={() => true}` to claim touch ownership without consuming touch events.

    The combined change replaces line 270:
    ```tsx
    // BEFORE:
    <Pressable style={styles.sheet} onPress={() => {}}>
      {/* ... content ... */}
    </Pressable>

    // AFTER:
    <View
      style={[styles.sheet, { paddingBottom: theme.spacing.lg + insets.bottom }]}
      onStartShouldSetResponder={() => true}
    >
      {/* ... content ... */}
    </View>
    ```

    The `onStartShouldSetResponder={() => true}` on a View claims responder status (preventing the overlay Pressable from receiving the touch and closing the sheet) WITHOUT the Pressable's touch-swallowing behavior on content changes. This is the standard RN pattern for "stop propagation without intercepting."

    Also remove the closing `</Pressable>` (currently line 424) and replace with `</View>`.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors.
    Visually confirm: the inner Pressable on line 270 is replaced with a View using onStartShouldSetResponder, and the useSafeAreaInsets hook is imported and used for paddingBottom.
  </verify>
  <done>
    - CTA button is fully visible above the home indicator on iPhone X+ devices
    - First touch/drag in the exercise picker list registers immediately after step transition
    - Sheet still blocks overlay dismissal when tapping inside (onStartShouldSetResponder)
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix KebabMenu dropdown positioning</name>
  <files>
    src/components/KebabMenu.tsx
  </files>
  <action>
    The KebabMenu dropdown appears at `top: 80` (hardcoded) regardless of where the trigger button actually is on screen. When ChartCards are further down the dashboard ScrollView, the dropdown appears at the wrong position.

    Fix: Use `View.measure()` on the trigger ref to capture the button's absolute screen coordinates when pressed, then position the dropdown relative to those measured coordinates.

    **Step-by-step implementation:**

    1. Add `useRef` import and create a ref for the trigger:
    ```tsx
    import { useState, useRef } from 'react';
    import { View, Text, Pressable, Modal, StyleSheet } from 'react-native';
    import type { View as ViewType } from 'react-native';
    ```

    2. Add state for measured trigger position and a ref for the trigger View:
    ```tsx
    const [triggerPos, setTriggerPos] = useState<{ x: number; y: number; width: number; height: number } | null>(null);
    const triggerRef = useRef<View>(null);
    ```

    3. Replace the trigger's `onPress` with a handler that measures first:
    ```tsx
    const handleOpenMenu = () => {
      triggerRef.current?.measure((x, y, width, height, pageX, pageY) => {
        setTriggerPos({ x: pageX, y: pageY, width, height });
        setMenuVisible(true);
      });
    };
    ```

    4. Wrap the trigger Pressable in a `<View ref={triggerRef} collapsable={false}>`:
    ```tsx
    <View ref={triggerRef} collapsable={false}>
      <Pressable
        onPress={handleOpenMenu}
        hitSlop={8}
        style={({ pressed }) => [
          styles.trigger,
          pressed && styles.triggerPressed,
        ]}
      >
        <Ionicons
          name="ellipsis-horizontal"
          size={20}
          color={theme.colors.textMuted}
        />
      </Pressable>
    </View>
    ```

    `collapsable={false}` is required for `measure()` to work on Android (and doesn't hurt iOS). The ref is on the wrapper View, not the Pressable, because Pressable doesn't reliably forward refs for measurement.

    5. Update the `dropdownAnchor` style to use measured position. Replace the hardcoded style with a dynamic one in the Modal:
    ```tsx
    <View style={[
      styles.dropdownAnchor,
      triggerPos ? {
        top: triggerPos.y + triggerPos.height,
        right: styles.dropdownAnchor.right,
      } : undefined,
    ]}>
    ```

    Actually, since styles are from StyleSheet.create and we need dynamic top, change the approach: remove `top: 80` from the static `dropdownAnchor` style and apply the measured top as an inline override.

    Updated `dropdownAnchor` style (remove hardcoded top):
    ```tsx
    dropdownAnchor: {
      position: 'absolute',
      right: theme.spacing.lg,
      alignItems: 'flex-end',
    },
    ```

    In the JSX, apply dynamic top:
    ```tsx
    <View style={[styles.dropdownAnchor, { top: triggerPos ? triggerPos.y + triggerPos.height : 80 }]}>
    ```

    This positions the dropdown directly below the trigger button's actual screen position. Falls back to 80 if measure somehow fails.

    6. Reset triggerPos when modal closes to avoid stale position:
    ```tsx
    const handleClose = () => {
      setMenuVisible(false);
      setTriggerPos(null);
    };
    ```

    Use `handleClose` in the overlay onPress and onRequestClose instead of inline `() => setMenuVisible(false)`.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors.
    Visually confirm: KebabMenu uses `useRef` + `measure()`, dropdown top is dynamic based on measured trigger position, `collapsable={false}` is set on the ref wrapper.
  </verify>
  <done>
    - Kebab menu dropdown appears directly below the three-dot icon regardless of ChartCard position in the ScrollView
    - Dropdown remains right-aligned with proper spacing
    - Position measurement works for all ChartCards at any scroll offset
  </done>
</task>

</tasks>

<verification>
After all 3 tasks complete:

1. `npx tsc --noEmit` passes with no errors
2. Code review confirms:
   - useChartData.ts: `[chart]` dependency (not `[chart.id]`)
   - ChartCard.tsx: `flexShrink: 0` on tooltip, `activatePointersOnLongPress: true`
   - AddChartSheet.tsx: View with `onStartShouldSetResponder` (not Pressable), `useSafeAreaInsets` for bottom padding
   - KebabMenu.tsx: `measure()` on trigger ref, dynamic `top` on dropdown
</verification>

<success_criteria>
All 6 UAT gaps addressed:
1. CTA button fully visible above home indicator (safe area padding)
2. Tooltip text displays on single line (flexShrink prevents collapse)
3. Kebab dropdown appears next to trigger icon (measured positioning)
4. Chart data refreshes after workout (dependency array includes whole chart object)
5. Exercise picker responds to first touch (View replaces Pressable)
6. Charts scroll horizontally (activatePointersOnLongPress enables scroll)
</success_criteria>

<output>
After completion, create `.planning/phases/06-charts/06-05-SUMMARY.md`
</output>
