---
phase: 06-charts
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/AddChartSheet.tsx
  - src/components/ChartCard.tsx
  - src/components/KebabMenu.tsx
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Add Chart bottom sheet shows full content including CTA button above the home indicator"
    - "Chart tooltip displays value text in a single readable line (e.g. '225 lbs')"
    - "Kebab menu dropdown appears next to the three-dot icon on the chart card, not at the top of the screen"
  artifacts:
    - path: "src/components/AddChartSheet.tsx"
      provides: "Safe area aware bottom sheet with fully visible CTA"
      contains: "paddingBottom"
    - path: "src/components/ChartCard.tsx"
      provides: "Non-collapsing tooltip container"
      contains: "flexShrink"
    - path: "src/components/KebabMenu.tsx"
      provides: "Position-measured dropdown menu"
      contains: "measure"
  key_links:
    - from: "src/components/AddChartSheet.tsx"
      to: "react-native SafeAreaView or useSafeAreaInsets"
      via: "safe area bottom padding on sheet"
      pattern: "paddingBottom.*insets\\.bottom|SafeAreaView"
    - from: "src/components/KebabMenu.tsx"
      to: "trigger button position"
      via: "View.measure() on press"
      pattern: "measure.*pageX.*pageY"
---

<objective>
Fix three UAT issues from Phase 6 charts testing: (1) Add Chart bottom sheet CTA button cut off by home indicator, (2) chart tooltip text wrapping into unreadable vertical stack, (3) kebab menu dropdown appearing at top of screen instead of next to trigger icon.

Purpose: Close all remaining gaps from Phase 6 UAT to deliver a polished charts experience.
Output: Three fixed components that pass all UAT test cases.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-charts/06-UAT.md
@.planning/debug/add-chart-sheet-cta-cutoff.md
@.planning/debug/chart-tooltip-text-width.md
@.planning/debug/kebab-menu-positioning.md
@src/components/AddChartSheet.tsx
@src/components/ChartCard.tsx
@src/components/KebabMenu.tsx
@src/components/ExercisePickerModal.tsx (SafeAreaView pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix AddChartSheet CTA cutoff and ChartCard tooltip width</name>
  <files>src/components/AddChartSheet.tsx, src/components/ChartCard.tsx</files>
  <action>
**AddChartSheet.tsx — Fix CTA button cut off by home indicator:**

The sheet uses a fixed 50% height without accounting for safe area insets. The buttonRow with `marginTop: 'auto'` pushes into the home indicator zone on iPhone X+ devices.

Fix using `useSafeAreaInsets` approach (Option 2 from debug report). Do NOT use SafeAreaView wrapper because this is a half-height bottom sheet anchored to the bottom — SafeAreaView would add top inset padding too, which is wrong for a bottom sheet. Instead:

1. Add import: `import { useSafeAreaInsets } from 'react-native-safe-area-context';`
2. Inside the component function, call `const insets = useSafeAreaInsets();`
3. On the `sheet` Pressable (line 270), apply the bottom inset as additional paddingBottom:
   ```tsx
   <Pressable
     style={[styles.sheet, { paddingBottom: theme.spacing.lg + insets.bottom }]}
     onPress={() => {}}
   >
   ```
   This adds the device's bottom safe area inset on top of the existing `padding: theme.spacing.lg`, ensuring the CTA buttons remain fully visible above the home indicator.

Do NOT change the SHEET_HEIGHT constant. Do NOT wrap in SafeAreaView. The fix is purely additive bottom padding.

**ChartCard.tsx — Fix tooltip text wrapping:**

The tooltip View container (styles.tooltip) lacks width constraints, causing the parent gifted-charts pointer component to collapse it to minimum width. Text wraps at character boundaries, stacking letters vertically.

1. In the `getStyles` function, add `flexShrink: 0` to the `tooltip` style object to prevent the container from collapsing:
   ```tsx
   tooltip: {
     backgroundColor: "rgba(0,0,0,0.8)",
     borderRadius: theme.radii.sm,
     paddingHorizontal: theme.spacing.sm,
     paddingVertical: theme.spacing.xs,
     flexShrink: 0,
   },
   ```

2. Also add `flexWrap: 'nowrap'` as a safety net to the `tooltipText` style to explicitly prevent text wrapping:
   ```tsx
   tooltipText: {
     color: "#ffffff",
     fontSize: theme.typography.sizes.xs,
     fontWeight: theme.typography.weights.medium,
     flexWrap: 'nowrap',
   },
   ```

These are style-only changes. No structural changes to the component.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Visually inspect on device: open Add Chart sheet and confirm CTA button is fully visible. Tap a chart data point and confirm tooltip text reads as a single horizontal line (e.g. "225 lbs").
  </verify>
  <done>
Add Chart bottom sheet CTA button is fully visible above the home indicator on iPhone. Chart tooltip displays value text in a single readable line without character-level wrapping.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix KebabMenu dropdown positioning</name>
  <files>src/components/KebabMenu.tsx</files>
  <action>
The KebabMenu uses a hardcoded `top: 80` in the dropdownAnchor style. When a Modal renders full-screen, the dropdown always appears at y=80 regardless of the trigger button's actual screen position.

Fix by measuring the trigger button's absolute screen position on press, then positioning the dropdown relative to those coordinates.

1. Add `useRef` and `useCallback` to the React imports (alongside existing `useState`).

2. Create a ref for the trigger View container (the outer `<View>` wrapping the Pressable trigger):
   ```tsx
   const triggerRef = useRef<View>(null);
   const [menuPosition, setMenuPosition] = useState<{ top: number; right: number }>({ top: 0, right: 0 });
   ```

3. Replace the trigger's `onPress` handler. Instead of directly setting `setMenuVisible(true)`, measure the trigger's position first:
   ```tsx
   const handleOpenMenu = useCallback(() => {
     triggerRef.current?.measure((x, y, width, height, pageX, pageY) => {
       const screenWidth = Dimensions.get('window').width;
       setMenuPosition({
         top: pageY + height,
         right: screenWidth - pageX - width,
       });
       setMenuVisible(true);
     });
   }, []);
   ```

4. Add `Dimensions` to the `react-native` import (alongside existing View, Text, Pressable, Modal, StyleSheet).

5. Attach the ref to the outer View wrapping the trigger Pressable:
   ```tsx
   <View ref={triggerRef}>
     <Pressable onPress={handleOpenMenu} ...>
   ```

6. Update the `dropdownAnchor` style in getStyles to remove the hardcoded `top: 80`. Since the position is now dynamic, apply it inline:
   ```tsx
   <View style={[styles.dropdownAnchor, { top: menuPosition.top, right: menuPosition.right }]}>
   ```

7. Update the `dropdownAnchor` style in getStyles to only keep structural properties (remove top and right since they're now inline):
   ```tsx
   dropdownAnchor: {
     position: 'absolute',
     alignItems: 'flex-end',
   },
   ```

This ensures the dropdown menu appears directly below the three-dot icon regardless of where the ChartCard is positioned in the scrolling dashboard.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. On device: scroll to a chart card, tap the kebab menu icon, and confirm the dropdown appears directly below the three-dot icon (not at the top of the screen). Test with multiple chart cards at different scroll positions.
  </verify>
  <done>
Kebab menu dropdown appears directly below the three-dot icon on each chart card, regardless of the card's position in the scrollable dashboard.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed three UAT issues: (1) AddChartSheet CTA button now visible above home indicator via safe area bottom padding, (2) chart tooltip text displays in a single readable line via flexShrink:0, (3) kebab menu dropdown appears next to the trigger icon via View.measure() positioning.</what-built>
  <how-to-verify>
1. Open the app on your iPhone
2. **Test Add Chart sheet (UAT #2):** Tap "+ Add Chart" in the charts section. Verify the Cancel and Add Chart buttons are FULLY visible at the bottom of the sheet, not cut off by the home indicator
3. **Test chart tooltip (UAT #7):** If you have a chart with data, tap on a data point. Verify the tooltip shows text like "225 lbs" or "12 sets" on a SINGLE line, not stacked vertically
4. **Test kebab menu (UAT #8):** Tap the three-dot menu on a chart card. Verify the Delete dropdown appears RIGHT NEXT TO the three-dot icon, not at the top of the screen. Try with charts at different scroll positions
  </how-to-verify>
  <resume-signal>Type "approved" if all three fixes work, or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no type errors
- UAT test 2 (Add Chart sheet): CTA button fully visible
- UAT test 7 (Chart tooltip): Text readable on single line
- UAT test 8 (Kebab menu): Dropdown appears next to trigger icon
</verification>

<success_criteria>
All three UAT gaps from Phase 6 are resolved:
1. Add Chart bottom sheet CTA is fully visible above home indicator
2. Chart tooltip text is readable in a single horizontal line
3. Kebab menu dropdown is positioned next to the trigger icon at any scroll position
</success_criteria>

<output>
After completion, create `.planning/phases/06-charts/06-05-SUMMARY.md`
</output>
