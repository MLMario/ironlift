---
phase: 06-charts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/charts.ts
  - src/lib/cache.ts
  - src/hooks/useCharts.ts
autonomous: true

must_haves:
  truths:
    - "Chart configurations can be created, read, and deleted via Supabase"
    - "Chart configs are cached in AsyncStorage for instant display"
    - "useCharts hook loads cached charts first, then fetches fresh from Supabase"
  artifacts:
    - path: "src/services/charts.ts"
      provides: "Chart CRUD operations (getUserCharts, createChart, deleteChart, reorderCharts, display helpers)"
      exports: ["charts"]
    - path: "src/lib/cache.ts"
      provides: "Chart cache functions alongside existing exercise/template cache"
      exports: ["getCachedCharts", "setCachedCharts", "clearChartCache"]
    - path: "src/hooks/useCharts.ts"
      provides: "Cache-first chart config loading hook"
      exports: ["useCharts"]
  key_links:
    - from: "src/services/charts.ts"
      to: "src/lib/supabase.ts"
      via: "Supabase client import"
      pattern: "import.*supabase.*from.*@/lib/supabase"
    - from: "src/hooks/useCharts.ts"
      to: "src/services/charts.ts"
      via: "charts service import"
      pattern: "import.*charts.*from.*@/services/charts"
    - from: "src/hooks/useCharts.ts"
      to: "src/lib/cache.ts"
      via: "cache functions import"
      pattern: "import.*getCachedCharts.*from.*@/lib/cache"
---

<objective>
Install chart dependencies, port chart CRUD service from web app, extend the cache layer with chart functions, and create the useCharts hook for cache-first chart config loading.

Purpose: Establishes the data layer that all chart UI components depend on. The service, cache, and hook must be in place before any chart rendering or creation UI can be built.
Output: Three new/modified files providing chart CRUD, caching, and a React hook.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-charts/06-CONTEXT.md
@.planning/phases/06-charts/06-RESEARCH.md

@src/types/services.ts (UserChartData, CreateChartInput, ChartData, ChartsService types already defined)
@src/services/logging.ts (getExerciseMetrics already ported -- used by chart data computation in Plan 02)
@src/services/exercises.ts (getExercisesWithLoggedData already implemented)
@src/hooks/useTemplates.ts (cache-first hook pattern to replicate)
@src/lib/cache.ts (extend with chart cache functions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install chart packages</name>
  <files>package.json</files>
  <action>
Run `npx expo install react-native-gifted-charts expo-linear-gradient` to install the two new chart dependencies. These are the only new packages for Phase 6 -- react-native-svg and react-native-reanimated are already installed as peer dependencies.

After installation, verify both packages appear in package.json dependencies and that the project still compiles by running `npx expo export --platform ios --dev` (dry run check -- cancel after it confirms no errors).
  </action>
  <verify>
Run `cat package.json | grep -E "gifted-charts|expo-linear-gradient"` to confirm both packages are listed.
  </verify>
  <done>Both react-native-gifted-charts and expo-linear-gradient appear in package.json dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Port chart CRUD service and extend cache</name>
  <files>src/services/charts.ts, src/lib/cache.ts</files>
  <action>
**Create `src/services/charts.ts`** by porting from the web app (`exercise_tracker_app/packages/shared/src/services/charts.ts`). Copy-and-adapt following the same pattern used for exercises and templates services:

1. Import supabase from `@/lib/supabase` (not `../lib/supabase`)
2. Import types from `@/types/services` (not `../types`)
3. Port these functions as-is (only import paths change):
   - `getUserCharts()` -- queries user_charts with exercises join, ordered by `order` ascending
   - `createChart(chartData)` -- gets max order, inserts with nextOrder. NOTE: the insert `.select()` returns the chart without the exercises join. After insert, re-fetch the single chart with exercises join so the returned `UserChartData` has the `exercises` field populated (the web version has this bug where it returns data without the join).
   - `deleteChart(id)` -- deletes from user_charts by id
   - `reorderCharts(chartIds)` -- Promise.all updates for order field (port but no UI this phase)
4. Port display helpers:
   - `getMetricDisplayName(metricType)` -- returns "Total Sets" or "Max Volume" (note: shorten from web's "Max Volume Set (lbs)" to just "Max Volume" for card title display)
   - `getModeDisplayName(mode)` -- returns "By Date" or "By Session"
5. DISCARD `renderChart`, `destroyChart`, `getChartModule`, `chartModuleCache` -- these are Chart.js-specific, replaced by declarative `<LineChart>` components
6. DISCARD the `import type { Chart } from 'chart.js'` and `import type { PostgrestSingleResponse }` lines
7. Export as `export const charts` object (NOT implementing the full ChartsService interface since it includes renderChart/destroyChart which we're discarding -- export the object without a type annotation, or create a subset type)

The service object should export: `{ getUserCharts, createChart, deleteChart, reorderCharts, getMetricDisplayName, getModeDisplayName }`

**Extend `src/lib/cache.ts`** with chart cache functions following the exact same pattern as exercises/templates:

1. Add `const CACHE_KEY_CHARTS = 'ironlift:charts'`
2. Add `getCachedCharts(): Promise<UserChartData[] | null>` -- parse from AsyncStorage, return null on miss/error
3. Add `setCachedCharts(charts: UserChartData[]): Promise<void>` -- stringify and store, log error on failure
4. Add `clearChartCache(): Promise<void>` -- removeItem, log error on failure
5. Import `UserChartData` from `@/types/services`
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. Check that:
- `src/services/charts.ts` exports a `charts` object with getUserCharts, createChart, deleteChart, reorderCharts, getMetricDisplayName, getModeDisplayName
- `src/lib/cache.ts` exports getCachedCharts, setCachedCharts, clearChartCache
  </verify>
  <done>Chart CRUD service compiles with no errors. Cache module has chart functions alongside existing exercise/template cache functions. No Chart.js imports or rendering code present.</done>
</task>

<task type="auto">
  <name>Task 3: Create useCharts hook</name>
  <files>src/hooks/useCharts.ts</files>
  <action>
Create `src/hooks/useCharts.ts` following the exact same cache-first pattern as `useTemplates.ts`:

1. State: `chartList: UserChartData[]`, `isLoading: boolean`, `error: string | null`
2. `loadCharts` callback (memoized with useCallback):
   - Set isLoading=true, error=null
   - Step 1: Try cache first (`getCachedCharts()`). If found, set chartList and isLoading=false, mark hasCachedData=true
   - Step 2: Fetch fresh from Supabase (`charts.getUserCharts()`). If data, update chartList and cache (`setCachedCharts`). If error and no cached data, set error message "Failed to load charts."
   - Set isLoading=false
3. useEffect on mount calls loadCharts()
4. Return `{ charts: chartList, isLoading, error, refresh: loadCharts }`

Import `UserChartData` from `@/types/services`, `charts` from `@/services/charts`, `getCachedCharts`/`setCachedCharts` from `@/lib/cache`.

This is a near-identical clone of useTemplates.ts with "template" replaced by "chart". Keep the same error handling patterns (silent cache errors, network errors shown only when no cached data).
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. The hook should have the same function signature pattern as useTemplates.
  </verify>
  <done>useCharts hook compiles cleanly, follows identical cache-first pattern as useTemplates, returns { charts, isLoading, error, refresh }.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/services/charts.ts` contains getUserCharts, createChart, deleteChart, reorderCharts, getMetricDisplayName, getModeDisplayName -- NO renderChart, destroyChart, or Chart.js imports
3. `src/lib/cache.ts` has CACHE_KEY_CHARTS and three chart cache functions
4. `src/hooks/useCharts.ts` follows useTemplates.ts cache-first pattern
5. Both new packages in package.json
</verification>

<success_criteria>
- react-native-gifted-charts and expo-linear-gradient installed in package.json
- Chart CRUD service ported with only import path changes (no Chart.js code)
- Cache layer extended with chart functions
- useCharts hook provides cache-first chart config loading
- All files compile with `npx tsc --noEmit`
</success_criteria>

<output>
After completion, create `.planning/phases/06-charts/06-01-SUMMARY.md`
</output>
