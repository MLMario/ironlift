---
phase: 13-test-harness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - jest.config.ts
  - jest-setup.ts
autonomous: true

must_haves:
  truths:
    - "npm test runs Jest without configuration errors"
    - "Jest resolves @/* path alias imports correctly"
    - "Reanimated, Gesture Handler, AsyncStorage, and Supabase are mocked globally"
    - "Environment variables are set so Supabase client module does not throw on import"
  artifacts:
    - path: "jest.config.ts"
      provides: "Jest configuration with jest-expo preset"
      contains: "preset.*jest-expo"
    - path: "jest-setup.ts"
      provides: "Global test setup with all required mocks"
      contains: "setUpTests"
    - path: "package.json"
      provides: "Test runner scripts and dev dependencies"
      contains: "jest-expo"
  key_links:
    - from: "jest.config.ts"
      to: "jest-setup.ts"
      via: "setupFilesAfterSetup reference"
      pattern: "setupFilesAfterSetup.*jest-setup"
    - from: "jest.config.ts"
      to: "node_modules/jest-expo"
      via: "preset field"
      pattern: "preset.*jest-expo"
---

<objective>
Install Jest + RNTL dependencies and create the test harness configuration for the IronLift Expo app.

Purpose: Establish the foundational test infrastructure so that unit and component tests can be written and run reliably. This is the prerequisite for all future testing.
Output: Working Jest configuration with all React Native mocks, a global setup file, and npm scripts for running tests.
</objective>

<execution_context>
@C:\Users\MarioPC\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\MarioPC\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-test-harness/13-RESEARCH.md
@package.json
@tsconfig.json
@src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install test dependencies and add npm scripts</name>
  <files>package.json</files>
  <action>
Install the following dev dependencies using the exact commands from research:

```bash
npx expo install jest-expo jest @types/jest -- --save-dev
npm install --save-dev @testing-library/react-native react-test-renderer@19.1.0
```

Key version constraints:
- `jest-expo` must match SDK 54 (npx expo install handles this)
- `react-test-renderer` must be exactly 19.1.0 (matching the project's React version)
- Do NOT install `@testing-library/jest-native` (deprecated; matchers are built into RNTL v13+)

After installation, add these scripts to package.json:
```json
"test": "jest",
"test:watch": "jest --watchAll",
"test:coverage": "jest --coverage"
```

If peer dependency warnings appear for react-test-renderer (React 19 deprecation), they can be safely ignored.
  </action>
  <verify>
Run `npm ls jest-expo @testing-library/react-native react-test-renderer @types/jest` and confirm all four packages are installed.
Confirm package.json has "test", "test:watch", and "test:coverage" scripts.
  </verify>
  <done>All test dependencies installed at correct versions; npm scripts added to package.json.</done>
</task>

<task type="auto">
  <name>Task 2: Create Jest configuration and global setup file</name>
  <files>jest.config.ts, jest-setup.ts</files>
  <action>
Create `jest.config.ts` at project root with:
- `preset: 'jest-expo'` (handles transforms, module resolution, platform mocking)
- `setupFilesAfterSetup: ['<rootDir>/jest-setup.ts']` (runs after Jest environment is ready)
- `transformIgnorePatterns` that includes ALL React Native libraries used in the project. The regex must whitelist: react-native, @react-native, expo, @expo, react-navigation, @react-navigation, react-native-svg, react-native-reanimated, react-native-gesture-handler, react-native-gifted-charts, react-native-worklets, react-native-screens, react-native-safe-area-context, @supabase, @react-native-async-storage, @react-native-community
- `collectCoverageFrom: ['src/**/*.{ts,tsx}', '!src/types/**', '!**/*.d.ts']`

IMPORTANT: The `jest-expo` preset should auto-resolve the `@/*` path alias from tsconfig.json. If it does NOT work during verification (Task 1 in Plan 02 will test this), a manual `moduleNameMapper: { '^@/(.*)$': '<rootDir>/src/$1' }` can be added as a fallback. Do NOT add it preemptively -- let jest-expo handle it first.

Create `jest-setup.ts` at project root with these mocks in order:

1. Reanimated mock (must be first): `require('react-native-reanimated').setUpTests();`
2. Gesture Handler mock: `import 'react-native-gesture-handler/jestSetup';`
3. AsyncStorage mock: `jest.mock('@react-native-async-storage/async-storage', () => require('@react-native-async-storage/async-storage/jest/async-storage-mock'));`
4. Environment variables for Supabase (prevent throw on import):
   ```
   process.env.EXPO_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';
   process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY = 'test-anon-key';
   ```
5. Mock `expo-sqlite/localStorage/install` with in-memory localStorage polyfill (the Supabase client imports this at line 1 and it requires native SQLite bindings unavailable in Jest)
6. Mock `@/lib/supabase` globally to prevent the real module from loading (it has side effects: reads env vars, calls AppState.addEventListener). Provide a chainable mock object for `supabase.from()` and mock auth methods.
7. Mock `react-native/Libraries/Animated/NativeAnimatedHelper` to suppress console warnings.

Reference the exact code patterns from 13-RESEARCH.md Pattern 2 (Global Test Setup File).
  </action>
  <verify>
Run `npx jest --listReporters` (or similar dry-run command) to confirm Jest loads the configuration without errors.
Verify jest.config.ts exists with preset, setupFilesAfterSetup, transformIgnorePatterns, and collectCoverageFrom.
Verify jest-setup.ts exists with all 7 mock sections.
  </verify>
  <done>Jest configuration loads without errors. Global setup file contains all required mocks for Reanimated, Gesture Handler, AsyncStorage, Supabase env vars, expo-sqlite/localStorage, Supabase client, and NativeAnimatedHelper.</done>
</task>

</tasks>

<verification>
1. `npx jest --showConfig` runs without errors and shows correct preset, setupFiles, and transformIgnorePatterns
2. All test dependencies present in package.json devDependencies
3. No `@testing-library/jest-native` in dependencies (deprecated)
</verification>

<success_criteria>
- jest-expo, jest, @types/jest, @testing-library/react-native, and react-test-renderer@19.1.0 are in devDependencies
- package.json has test, test:watch, and test:coverage scripts
- jest.config.ts correctly configures the jest-expo preset with all necessary transformIgnorePatterns
- jest-setup.ts initializes all mocks needed for the React Native + Supabase + Expo environment
- `npx jest --showConfig` executes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-test-harness/13-01-SUMMARY.md`
</output>
